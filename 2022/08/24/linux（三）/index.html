<!DOCTYPE HTML>
<html lang="zh-CN">
    <!-- hcs-21 郝帅  modify 2022.06.24-->



<head>
    <meta charset="utf-8">
    <meta name="keywords" content="linux的使用教程（三）, BigData">
    <meta name="baidu-site-verification" content="fmlEuI34ir" />
    <meta name="google-site-verification" content="KeoTn_OFy4ndJwXNmm2gMeQfPhd7alqE9vQDwI32KCY" />
    <meta name="description" content="阅读须知
本篇文章仅供参考


十七、使用Ansible服务实现自动化运维
17.1、Ansible介绍与安装Ansible目前是运维自动化工具中最简单、容易上手的一款优秀软件，能够用来管理各种资源。用户可以使
用Ansible自动部署应用">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>linux的使用教程（三） | 郝春帅的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/aos/3.0.0-beta.6/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcss.com/lightgallery/1.6.12/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    
    <style type="text/css">
        
    </style>
    
    <script src="https://libs.baidu.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    
    
    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

<meta name="generator" content="Hexo 6.2.0"></head>

    <body>

        <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">郝春帅的博客</span>
                </a>
            </div>
            


<!-- <a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/AV" class="waves-effect waves-light">
            
            <i class="fa fa-music"></i>
            
            <span>视听</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/galleries" class="waves-effect waves-light">
            
            <i class="fa fa-photo"></i>
            
            <span>相册</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于我</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul> -->

<!-- 支持二级菜单特性 洪卫 shw2018 modify 2019.09.17  -->
<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/" class="waves-effect waves-light">
              
                <i class="fa fa-home"></i>
              
              <span>首页</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/tags" class="waves-effect waves-light">
              
                <i class="fa fa-tags"></i>
              
              <span>标签</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/categories" class="waves-effect waves-light">
              
                <i class="fa fa-bookmark"></i>
              
              <span>分类</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/archives" class="waves-effect waves-light">
              
                <i class="fa fa-archive"></i>
              
              <span>归档</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/AV" class="waves-effect waves-light">
              
                <i class="fa fa-music"></i>
              
              <span>视听</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/galleries" class="waves-effect waves-light">
              
                <i class="fa fa-photo"></i>
              
              <span>相册</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/about" class="waves-effect waves-light">
              
                <i class="fa fa-user-circle-o"></i>
              
              <span>关于我</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/friends" class="waves-effect waves-light">
              
                <i class="fa fa-address-book"></i>
              
              <span>友情链接</span>
            </a>

            
      </li>
    

    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">郝春帅的博客</div>
        <div class="logo-desc">
            
            什么也不会的小白
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/AV" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-music"></i>
                
                视听
            </a>
        </li>
        
        <li>
            <a href="/galleries" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-photo"></i>
                
                相册
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于我
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/hcs-21/hcs-21.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>

   
   
<!-- 支持二级菜单特性 洪卫 shw2018 modify 2019.09.17  -->
<!-- <ul class="menu-list mobile-menu-list">
    
        <li class="m-nav-item">
                
                    <a href="/" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-home"></i>
                        
                        首页
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/tags" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-tags"></i>
                        
                        标签
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/categories" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-bookmark"></i>
                        
                        分类
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/archives" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-archive"></i>
                        
                        归档
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/AV" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-music"></i>
                        
                        视听
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/galleries" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-photo"></i>
                        
                        相册
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/about" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-user-circle-o"></i>
                        
                        关于我
                    </a>
              
            </li>
        
        <li class="m-nav-item">
                
                    <a href="/friends" class="waves-effect waves-light">
                        
                        <i class="fa fa-fw fa-address-book"></i>
                        
                        友情链接
                    </a>
              
            </li>
        

        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/hcs-21/hcs-21.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul> -->

</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/hcs-21/hcs-21.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

        
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/13.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        linux的使用教程（三）
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- shw2018 洪卫  modify 2019.08.15-->
<!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/linux/" target="_blank">
                                <span class="chip bg-color">linux</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E7%B3%BB%E7%BB%9F/" class="post-category" target="_blank">
                                系统
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-08-24
                </div>
    
                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                        郝帅
                    
                </div>
    
                
                
                        <span id="busuanzi_container_site_pv" style='display:none'></span>
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv" ></span>
    
                
    
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="阅读须知"><a href="#阅读须知" class="headerlink" title="阅读须知"></a>阅读须知</h2><blockquote>
<p>本篇文章仅供参考</p>
</blockquote>
<hr>
<h2 id="十七、使用Ansible服务实现自动化运维"><a href="#十七、使用Ansible服务实现自动化运维" class="headerlink" title="十七、使用Ansible服务实现自动化运维"></a>十七、使用<code>Ansible</code>服务实现自动化运维</h2><hr>
<h3 id="17-1、Ansible介绍与安装"><a href="#17-1、Ansible介绍与安装" class="headerlink" title="17.1、Ansible介绍与安装"></a>17.1、<code>Ansible</code>介绍与安装</h3><p><code>Ansible</code>目前是运维自动化工具中最简单、容易上手的一款优秀软件，能够用来管理各种资源。用户可以使</p>
<p>用<code>Ansible</code>自动部署应用程序，以此实现IT基础架构的全面部署。例如，借助于<code>Ansible</code>，我们可以轻松地</p>
<p>对服务器进行初始化配置、安全基线配置，以及进行更新和打补丁操作。相较于<code>Chef</code>、<code>Puppet</code>、</p>
<p><code>SaltStack</code>等C&#x2F;S（客户端&#x2F;服务器）架构的自动化工具来讲，尽管<code>Ansible</code>的性能并不是最好的，但由于它</p>
<p>基于SSH远程会话协议，不需要客户端程序，只要知道受管主机的账号密码，就能直接用SSH协议进行远程控</p>
<p>制</p>
<blockquote>
<p><code> Ansible</code>服务专用术语对照表因此使用起来优势明显。</p>
</blockquote>
<table>
<thead>
<tr>
<th>术语</th>
<th>中文叫法</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>Control node</td>
<td>控制节点</td>
<td>指的是安装了Ansible服务的主机，也被称为Ansible控制端，主要是用来发布运行任务、调用功能模块，对其他主机进行批量控制。</td>
</tr>
<tr>
<td>Managed nodes</td>
<td>受控节点</td>
<td>指的是被Ansible服务所管理的主机，也被称为受控主机或客户端，是模块<a target="_blank" rel="noopener" href="https://www.linuxcool.com/">命令</a>的被执行对象。</td>
</tr>
<tr>
<td>Inventory</td>
<td>主机清单</td>
<td>指的是受控节点的列表，可以是IP地址、主机名称或者域名。</td>
</tr>
<tr>
<td>Modules</td>
<td>模块</td>
<td>指的是上文提到的特定功能代码，默认自带有上千款功能模块，在Ansible Galaxy有超多可供选择。</td>
</tr>
<tr>
<td>Task</td>
<td>任务</td>
<td>指的是Ansible客户端上面要被执行的操作。</td>
</tr>
<tr>
<td>Playbook</td>
<td>剧本</td>
<td>指的是通过YAML语言编写的可重复执行的任务列表，把常做的操作写入到剧本文件中，下次可以直接重复执行一遍。</td>
</tr>
<tr>
<td>Roles</td>
<td>角色</td>
<td>从Ansible 1.2版本开始引入的新特性，用于结构化的组织Playbook，通过调用角色实现一连串的功能。</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>第1步：</strong>在“虚拟机设置”界面中，将“网络适配器”的“网络连接”选项调整为“桥接模式”，并将系统的网卡设</p>
<p>置成“<code>Automatic</code>（<code>DHCP</code>）”模式，如图17-1及图17-2所示。</p>
</blockquote>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825083422868.png" alt="图17-1 将“网络连接”设置为“桥接模式”"></p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825083441177.png" alt="图17-2 将网卡设置为“Automatic（DHCP）”模式"></p>
<p>在大多数情况下，只要把虚拟机设置成桥接模式，且<code>Linux</code>系统的网卡信息与物理机相同，然后再重启网络</p>
<p>服务，就可以连接外部网络了。如果不放心，可以通过ping命令进行测试。</p>
<pre><code class="bash">[root@linuxprobe ~]# nmcli connection up ens160 
Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/4)
[root@linuxprobe ~]# ping -c 4 www.linuxprobe.com
PING www.linuxprobe.com.w.kunlunno.com (124.95.157.160) 56(84) bytes of data.
64 bytes from www.linuxprobe.com (124.95.157.160): icmp_seq=1 ttl=53 time=17.1 ms
64 bytes from www.linuxprobe.com (124.95.157.160): icmp_seq=2 ttl=53 time=15.6 ms
64 bytes from www.linuxprobe.com (124.95.157.160): icmp_seq=3 ttl=53 time=16.8 ms
64 bytes from www.linuxprobe.com (124.95.157.160): icmp_seq=4 ttl=53 time=17.5 ms

--- www.linuxprobe.com.w.kunlunno.com ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 10ms
rtt min/avg/max/mdev = 15.598/16.732/17.452/0.708 ms
</code></pre>
<blockquote>
<p><strong>第2步：</strong>在原有软件仓库配置的下方，追加<code>EPEL</code>扩展软件包安装源的信息。</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# vim /etc/yum.repos.d/rhel.repo
[BaseOS]
name=BaseOS
baseurl=file:///media/cdrom/BaseOS
enabled=1
gpgcheck=0

[AppStream]
name=AppStream
baseurl=file:///media/cdrom/AppStream
enabled=1
gpgcheck=0

[EPEL]
name=EPEL
baseurl=https://dl.fedoraproject.org/pub/epel/8/Everything/x86_64/
enabled=1
gpgcheck=0
</code></pre>
<blockquote>
<p><strong>第3步：</strong>安装！</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# yum install -y ansible
</code></pre>
<p>安装完毕后，<code>Ansible</code>服务便默认已经启动。使用<code>--version</code>参数可以看到<code>Ansible</code>服务的版本及配置信</p>
<p>息。</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible --version
ansible 2.9.18
  config file = /etc/ansible/ansible.cfg
  configured module search path = [&#39;/root/.ansible/plugins/modules&#39;, &#39;/usr/share/ansible/plugins/modules&#39;]
  ansible python module location = /usr/lib/python3.6/site-packages/ansible
  executable location = /usr/bin/ansible
  python version = 3.6.8 (default, Jan 11 2019, 02:17:16) [GCC 8.2.1 20180905 (Red Hat 8.2.1-3)]
</code></pre>
<h3 id="17-2、设置主机清单"><a href="#17-2、设置主机清单" class="headerlink" title="17.2、设置主机清单"></a>17.2、设置主机清单</h3><p>在初次使用<code>Ansible</code>服务时，大家可能会遇到这种情况：参数明明已经修改了，但却不生效。这是因为</p>
<p><code>Ansible</code>服务的主配置文件存在优先级的顺序关系，默认存放在<code>/etc/ansible</code>目录中的主配置文件优先级</p>
<p>最低。如果在当前目录或用户家目录中也存放着一份主配置文件，则以当前目录或用户家目录中的主配置文件</p>
<p>为主。同时存在多个<code>Ansible</code>服务主配置文件时，具体优先级顺序如表所示。</p>
<blockquote>
<p><code>Ansible</code>服务主配置文件优先级顺序</p>
</blockquote>
<table>
<thead>
<tr>
<th>优先级</th>
<th>文件位置</th>
</tr>
</thead>
<tbody><tr>
<td>高</td>
<td>.&#x2F;ansible.cfg</td>
</tr>
<tr>
<td>中</td>
<td>~&#x2F;.ansible.cfg</td>
</tr>
<tr>
<td>低</td>
<td>&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</td>
</tr>
</tbody></table>
<p>例如，要管理5台主机，对应的IP地址如表所示。</p>
<table>
<thead>
<tr>
<th>操作系统</th>
<th>IP地址</th>
<th>功能用途</th>
</tr>
</thead>
<tbody><tr>
<td>RHEL 8</td>
<td>192.168.10.20</td>
<td>dev</td>
</tr>
<tr>
<td>RHEL 8</td>
<td>192.168.10.21</td>
<td>test</td>
</tr>
<tr>
<td>RHEL 8</td>
<td>192.168.10.22</td>
<td>prod</td>
</tr>
<tr>
<td>RHEL 8</td>
<td>192.168.10.23</td>
<td>prod</td>
</tr>
<tr>
<td>RHEL 8</td>
<td>192.168.10.24</td>
<td>balancers</td>
</tr>
</tbody></table>
<p>首先需要说明的是，受管主机的系统默认使用<code>RHEL 8</code>，这是为了避免大家在准备实验机阶段产生歧义而给出</p>
<p>的建议值，也可以用其他<code>Linux</code>系统。主机清单文件<code>/etc/ansible/hosts</code>中默认存在大量的注释信息，建</p>
<p>议全部删除，然后替换成实验信息。</p>
<pre><code class="bash">[root@linuxprobe ~]# vim /etc/ansible/hosts
192.168.10.20
192.168.10.21
192.168.10.22
192.168.10.23
192.168.10.24
</code></pre>
<p>为了增加实验难度，“通吃”生产环境中的常见需求，我们又为这5台主机分别规划了功能用途，有开发机</p>
<p>（<code>dev</code>）、测试机（<code>test</code>）、产品机（<code>prod</code>）（两台）和负载均衡机（<code>balancers</code>）。在对主机进行分组</p>
<p>标注后，后期在管理时就方便多了。</p>
<pre><code class="bash">[root@linuxprobe ~]# vim /etc/ansible/hosts
[dev]
192.168.10.20
[test]
192.168.10.21
[prod]
192.168.10.22
192.168.10.23
[balancers]
192.168.10.24
</code></pre>
<p>主机清单文件在修改后会立即生效，一般使用“<code>ansible-inventory --graph</code>”命令以结构化的方式显示出受</p>
<p>管主机的信息。因为我们对受管主机进行了分组，因此这种方式非常便于我们的阅读。</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-inventory --graph
@all:
  |--@balancers:
  |  |--192.168.10.24
  |--@dev:
  |  |--192.168.10.20
  |--@prod:
  |  |--192.168.10.22
  |  |--192.168.10.23
  |--@test:
  |  |--192.168.10.21
  |--@ungrouped:
</code></pre>
<p>正常的第一次<code>SSH</code>远程连接过程是这样的</p>
<pre><code class="bash">[root@linuxprobe ~]# ssh 192.168.10.10
The authenticity of host &#39;192.168.10.10 (192.168.10.10)&#39; can&#39;t be established.
ECDSA key fingerprint is SHA256:QRW1wrqdwN0PI2bsUvBlW5XOIpBjE+ujCB8yiCqjMQQ.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added &#39;192.168.10.10&#39; (ECDSA) to the list of known hosts.
root@192.168.10.10&#39;s password: 此处应输入管理员密码后回车确认
Activate the web console with: systemctl enable --now cockpit.socket

Last login: Mon Mar 29 06:30:15 2021
[root@linuxprobe ~]# 
</code></pre>
<p><code>Ansible</code>服务已经对此有了解决办法，那就是使用如表所示的变量。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>ansible_ssh_host</td>
<td>受管主机名</td>
</tr>
<tr>
<td>ansible_ssh_port</td>
<td>端口号</td>
</tr>
<tr>
<td>ansible_ssh_user</td>
<td>默认账号</td>
</tr>
<tr>
<td>ansible_ssh_pass</td>
<td>默认密码</td>
</tr>
<tr>
<td>ansible_shell_type</td>
<td>Shell终端类型</td>
</tr>
</tbody></table>
<p>用户只需要将对应的变量及信息填写到主机清单文件中，在执行任务时便会自动对账号和密码进行匹配，而不</p>
<p>用每次重复输入它们。继续修改主机清单文件</p>
<pre><code class="bash">[root@linuxprobe ~]# vim /etc/ansible/hosts
[dev]
192.168.10.20
[test]
192.168.10.21
[prod]
192.168.10.22
192.168.10.23
[balancers]
192.168.10.24
[all:vars]
ansible_user=root
ansible_password=redhat
</code></pre>
<p>还剩最后一步。将<code>Ansible</code>主配置文件中的第71行设置成默认不需要SSH协议的指纹验证，以及将第107行设</p>
<p>置成默认执行剧本时所使用的管理员名称为<code>root</code></p>
<pre><code class="bash">[root@linuxprobe ~]# vim /etc/ansible/ansible.cfg
69
70 # uncomment this to disable SSH key host checking
71 host_key_checking = False
72
………………省略部分输出信息………………
104
105 # default user to use for playbooks if user is not specified
106 # (/usr/bin/ansible will use current user as default)
107 remote_user = root
108
</code></pre>
<p>不需要重启服务，在以上操作完全搞定后就可以开始后面的实验了。由于刚才是将<code>Ansible</code>服务器设置成了</p>
<p>桥接及<code>DHCP</code>模式，现在请同学们自行将网络适配器修改回“仅主机模式”（见图17-3）以及192.168.10.10&#x2F;24</p>
<p>的<code>IP</code>地址。在修改完成后重启网卡，然后自行在主机之间执行<code>ping</code>操作。保证主机之间的网络能够互通是</p>
<p>后续实验的基石。</p>
<pre><code class="bash">[root@linuxprobe ~]# ifconfig
ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.10.10  netmask 255.255.255.0  broadcast 192.168.10.255
        inet6 fe80::d0bb:17c8:880d:e719  prefixlen 64  scopeid 0x20
        ether 00:0c:29:7d:27:bf  txqueuelen 1000  (Ethernet)
        RX packets 32  bytes 5134 (5.0 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 43  bytes 4845 (4.7 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
………………省略部分输出信息………………
</code></pre>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825085113979.png" alt="图17-3 将虚拟机网卡改回仅主机模式"></p>
<h3 id="17-3、运行临时命令"><a href="#17-3、运行临时命令" class="headerlink" title="17.3、运行临时命令"></a>17.3、运行临时命令</h3><blockquote>
<p> <code>Ansible</code>服务常用模块名称及作用</p>
<p>使用“<code>ansible-doc</code>模块名称”的命令格式自行查询，或是使用<code>ansibe-doc -l</code>命令列出所有的模块信息</p>
<p>以供选择。</p>
</blockquote>
<table>
<thead>
<tr>
<th>模块名称</th>
<th>模块作用</th>
</tr>
</thead>
<tbody><tr>
<td>ping</td>
<td>检查受管节点主机网络是否能够联通。</td>
</tr>
<tr>
<td>yum</td>
<td>安装、更新及卸载软件包。</td>
</tr>
<tr>
<td>yum_repository</td>
<td>管理主机的软件仓库配置文件。</td>
</tr>
<tr>
<td>template</td>
<td>复制模板文件到受管节点主机。</td>
</tr>
<tr>
<td>copy</td>
<td>新建、修改及复制文件。</td>
</tr>
<tr>
<td>user</td>
<td>创建、修改及删除用户。</td>
</tr>
<tr>
<td>group</td>
<td>创建、修改及删除用户组。</td>
</tr>
<tr>
<td>service</td>
<td>启动、关闭及查看服务状态。</td>
</tr>
<tr>
<td>get_url</td>
<td>从网络中下载文件。</td>
</tr>
<tr>
<td>file</td>
<td>设置文件权限及创建快捷方式。</td>
</tr>
<tr>
<td>cron</td>
<td>添加、修改及删除计划任务。</td>
</tr>
<tr>
<td>command</td>
<td>直接执行用户指定的命令。</td>
</tr>
<tr>
<td>shell</td>
<td>直接执行用户指定的命令（支持特殊字符）。</td>
</tr>
<tr>
<td>debug</td>
<td>输出调试或报错信息。</td>
</tr>
<tr>
<td>mount</td>
<td>挂载硬盘设备文件。</td>
</tr>
<tr>
<td>filesystem</td>
<td>格式化硬盘设备文件。</td>
</tr>
<tr>
<td>lineinfile</td>
<td>通过正则表达式修改文件内容。</td>
</tr>
<tr>
<td>setup</td>
<td>收集受管节点主机上的系统及变量信息。</td>
</tr>
<tr>
<td>firewalld</td>
<td>添加、修改及删除防火墙策略。</td>
</tr>
<tr>
<td>lvg</td>
<td>管理主机的物理卷及卷组设备。</td>
</tr>
<tr>
<td>lvol</td>
<td>管理主机的逻辑卷设备。</td>
</tr>
</tbody></table>
<p>在<code>Ansible</code>服务中，<code>ansible</code>是用于执行临时任务的命令，也就在是执行后即结束（与剧本文件的可重复执</p>
<p>行不同）。在使用<code>ansible</code>命令时，必须指明受管主机的信息，如果已经设置过主机清单文件</p>
<p>（<code>/etc/ansible/hosts</code>），则可以使用<code>all</code>参数来指代全体受管主机，或是用<code>dev</code>、<code>test</code>等主机组名称来</p>
<p>指代某一组的主机。</p>
<p><code>ansible</code>命令常用的语法格式为“<code>ansible</code>受管主机节点<code> -m</code>模块名称[<code>-a</code>模块参数]”，常见的参数如表所示。</p>
<p>其中，<code>-a</code>是要传递给模块的参数，只有功能极其简单的模块才不需要额外参数，所以大多情况下<code>-m</code>与<code>-a</code>参</p>
<p>数都会同时出现。</p>
<blockquote>
<p> <code>ansible</code>命令常用参数</p>
</blockquote>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-k</td>
<td>手动输入SSH协议密码</td>
</tr>
<tr>
<td>-i</td>
<td>指定主机清单文件</td>
</tr>
<tr>
<td>-m</td>
<td>指定要使用的模块名</td>
</tr>
<tr>
<td>-M</td>
<td>指定要使用的模块路径</td>
</tr>
<tr>
<td>-S</td>
<td>使用su命令</td>
</tr>
<tr>
<td>-T</td>
<td>设置SSH协议连接超时时间</td>
</tr>
<tr>
<td>-a</td>
<td>设置传递给模块的参数</td>
</tr>
<tr>
<td>–version</td>
<td>查看版本信息</td>
</tr>
<tr>
<td>-h</td>
<td>帮助信息</td>
</tr>
</tbody></table>
<p>如果想实现某个功能，但是却不知道用什么模块，又或者是知道了模块名称，但不清楚模块具体的作用，则建</p>
<p>议使用<code>ansible-doc</code>命令进行查找。例如，列举出当前<code>Ansible</code>服务所支持的所有模块信息</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-doc -l 
a10_server                                           Manage A10 Networks AX/SoftAX/Thunder/v...
a10_server_axapi3                                    Manage A10 Networks AX/SoftAX/Thunder/v...           
a10_service_group                                    Manage A10 Networks AX/SoftAX/Thunder/v...
a10_virtual_server                                   Manage A10 Networks AX/SoftAX/Thunder/v...
aci_aaa_user                                         Manage AAA users (aaa:User)                                              
aci_aaa_user_certificate                             Manage AAA user certificates (aaa:User...                        
aci_access_port_block_to_access_port                 Manage port blocks of Fabric interface ...
aci_access_port_to_interface_policy_leaf_profile     Manage Fabric interface policy leaf pro...
aci_access_sub_port_block_to_access_port             Manage sub port blocks of Fabric interf...
aci_aep                                              Manage attachable Access Entity Profile...
aci_aep_to_domain                                    Bind AEPs to Physical or Virtual Domain...   
aci_bd_subnet                                        Manage Subnets (fv:Subnet)                 
………………省略部分输出信息………………
</code></pre>
<p>一般情况下，很难通过名称来判别一个模块的作用，要么是参考模块后面的介绍信息，要么是平时多学多练，</p>
<p>进行积累。例如，接下来随机查看一个模块的详细信息。<code>ansible-doc</code>命令会在屏幕上显示出这个模块的作</p>
<p>用、可用参数及实例等信息</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-doc a10_server
&gt; A10_SERVER    (/usr/lib/python3.6/site-packages/ansible/modules/network/a10/a10_server.py)

     Manage SLB (Server Load Balancer) server objects on A10 Networks devices via aXAPIv2.

  * This module is maintained by The Ansible Community
………………省略部分输出信息………………
</code></pre>
<p>在17.2节，已经成功地将受管主机的IP地址填写到主机清单文件中，接下来小试牛刀，检查一下这些主机的网</p>
<p>络连通性。<code>ping</code>模块用于进行简单的网络测试（类似于常用的<code>ping</code>命令）。可以使用<code>ansible</code>命令直接针</p>
<p>对所有主机调用<code>ping</code>模块，不需要增加额外的参数，返回值若为<code>SUCCESS</code>，则表示主机当前在线。</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible all -m ping
192.168.10.20 | SUCCESS =&gt; &#123;
    &quot;ansible_facts&quot;: &#123;
        &quot;discovered_interpreter_python&quot;: &quot;/usr/libexec/platform-python&quot;
    &#125;,
    &quot;changed&quot;: false,
    &quot;ping&quot;: &quot;pong&quot;
&#125;
192.168.10.21 | SUCCESS =&gt; &#123;
    &quot;ansible_facts&quot;: &#123;
        &quot;discovered_interpreter_python&quot;: &quot;/usr/libexec/platform-python&quot;
    &#125;,
    &quot;changed&quot;: false,
    &quot;ping&quot;: &quot;pong&quot;
&#125;
192.168.10.22 | SUCCESS =&gt; &#123;
    &quot;ansible_facts&quot;: &#123;
        &quot;discovered_interpreter_python&quot;: &quot;/usr/libexec/platform-python&quot;
    &#125;,
    &quot;changed&quot;: false,
    &quot;ping&quot;: &quot;pong&quot;
&#125;
192.168.10.23 | SUCCESS =&gt; &#123;
    &quot;ansible_facts&quot;: &#123;
        &quot;discovered_interpreter_python&quot;: &quot;/usr/libexec/platform-python&quot;
    &#125;,
    &quot;changed&quot;: false,
    &quot;ping&quot;: &quot;pong&quot;
&#125;192.168.10.24 | SUCCESS =&gt; &#123;
    &quot;ansible_facts&quot;: &#123;
        &quot;discovered_interpreter_python&quot;: &quot;/usr/libexec/platform-python&quot;
    &#125;,
    &quot;changed&quot;: false,
    &quot;ping&quot;: &quot;pong&quot;
&#125;
</code></pre>
<p>除了使用<code>-m</code>参数直接指定模块名称之外，还可以用<code>-a</code>参数将参数传递给模块，让模块的功能更高级，更好地</p>
<p>满足当前生产的需求。例如，<code>yum_repository</code>模块的作用是管理主机的软件仓库，能够添加、修改及删除软</p>
<p>件仓库的配置信息，参数相对比较复杂。遇到这种情况时，建议先用<code>ansible-doc</code>命令对其进行了解。尤其</p>
<p>是下面的<code>EXAMPLES</code>结构段会有该模块的实例，对用户来说有非常高的参考价值。</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-doc yum_repository
&gt; YUM_REPOSITORY    (/usr/lib/python3.6/site-packages/ansible/modules/packaging&gt;

        Add or remove YUM repositories in RPM-based Linux
        distributions. If you wish to update an existing repository
        definition use [ini_file] instead.

  * This module is maintained by The Ansible Core Team

……………………省略部分输出信息………………

EXAMPLES:

- name: Add repository
  yum_repository:
    name: epel
    description: EPEL YUM repo
    baseurl: https://download.fedoraproject.org/pub/epel/$releasever/$basearch/

- name: Add multiple repositories into the same file (1/2)
  yum_repository:
    name: epel
    description: EPEL YUM repo
    file: external_repos
    baseurl: https://download.fedoraproject.org/pub/epel/$releasever/$basearch/
    gpgcheck: no

- name: Add multiple repositories into the same file (2/2)
  yum_repository:
    name: rpmforge
    description: RPMforge YUM repo
    file: external_repos
    baseurl: http://apt.sw.be/redhat/el7/en/$basearch/rpmforge
</code></pre>
<blockquote>
<p>还好，参数并不是很多，而且与此前学过的<code>/etc/yum.repos.d/</code>目录中的配置文件基本相似。现在，想</p>
<p>为主机清单中的所有服务器新增一个如表所示的软件仓库，该怎么操作呢？</p>
</blockquote>
<blockquote>
<p> 新增软件仓库信息</p>
</blockquote>
<table>
<thead>
<tr>
<th>仓库名称</th>
<th>EX294_BASE</th>
</tr>
</thead>
<tbody><tr>
<td>仓库描述</td>
<td>EX294 base software</td>
</tr>
<tr>
<td>仓库地址</td>
<td>file:&#x2F;&#x2F;&#x2F;media&#x2F;cdrom&#x2F;BaseOS</td>
</tr>
<tr>
<td>GPG签名</td>
<td>启用</td>
</tr>
<tr>
<td>GPG密钥文件</td>
<td>file:&#x2F;&#x2F;&#x2F;media&#x2F;cdrom&#x2F;RPM-GPG-KEY-redhat-release</td>
</tr>
</tbody></table>
<p>我们可以对照着<code>EXAMPLE</code>实例段，逐一对应填写需求值和参数，其标准格式是在<code>-a</code>参数后接整体参数（用单</p>
<p>引号圈起），而各个参数字段的值则用双引号圈起。这是最严谨的写法。在执行下述命令后如果出现</p>
<p><code>CHANGED字样</code>，则表示修改已经成功</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible all -m yum_repository -a &#39;name=&quot;EX294_BASE&quot; description=&quot;EX294 base software&quot; baseurl=&quot;file:///media/cdrom/BaseOS&quot; gpgcheck=yes enabled=1 gpgkey=&quot;file:///media/cdrom/RPM-GPG-KEY-redhat-release&quot;&#39;

192.168.10.20 | CHANGED =&gt; &#123;
    &quot;ansible_facts&quot;: &#123;
        &quot;discovered_interpreter_python&quot;: &quot;/usr/libexec/platform-python&quot;
    &#125;,
    &quot;changed&quot;: true,
    &quot;repo&quot;: &quot;EX294_BASE&quot;,
    &quot;state&quot;: &quot;present&quot;
&#125;
</code></pre>
<p>在命令执行成功后，可以到主机清单中的任意机器上查看新建成功的软件仓库配置文件。</p>
<pre><code class="bash">[root@linuxprobe ~]# cat /etc/yum.repos.d/EX294_BASE.repo 
[EX294_BASE]
baseurl = file:///media/cdrom/BaseOS
enabled = 1
gpgcheck = 1
gpgkey = file:///media/cdrom/RPM-GPG-KEY-redhat-release
name = EX294 base software
</code></pre>
<h3 id="17-4、剧本文件实践"><a href="#17-4、剧本文件实践" class="headerlink" title="17.4、剧本文件实践"></a>17.4、剧本文件实践</h3><p><code>Ansible</code>服务的剧本（<code>playbook</code>）文件采用<code>YAML</code>语言编写，具有强制性的格式规范，它通过空格将不同信</p>
<p>息分组，因此有时会因一两个空格错位而导致报错。大家在使用时要万分小心。<code>YAML</code>文件的开头需要先写3</p>
<p>个减号（—），多个分组的信息需要间隔一致才能执行，而且上下也要对齐，后缀名一般为<code>.yml</code>。剧本文件</p>
<p>在执行后，会在屏幕上输出运行界面，内容会根据工作的不同而变化。<strong>在运行界面中，绿色表示成功，黄色表</strong></p>
<p><strong>示执行成功并进行了修改，而红色则表示执行失败。</strong></p>
<blockquote>
<p>剧本文件的结构由4部分组成，分别是<code>target</code>、<code>variable</code>、<code>task</code>、<code>handler</code>，其各自的作用如下:</p>
<ul>
<li><strong>target</strong>：用于定义要执行剧本的主机范围。</li>
<li><strong>variable</strong>：用于定义剧本执行时要用到的变量。</li>
<li><strong>task</strong>：用于定义将在远程主机上执行的任务列表。</li>
<li><strong>handler</strong>：用于定义执行完成后需要调用的后续任务。</li>
</ul>
</blockquote>
<p><code>YAML</code>语言编写的<code>Ansible</code>剧本文件会按照从上到下的顺序自动运行，其形式类似于第5章介绍的<code>Shell</code>脚本</p>
<p>但格式有严格的要求。例如，创建一个名为<code>packages.yml</code>的剧本，让<code>dev</code>、<code>test</code>和<code>prod</code>组的主机可以自动</p>
<p>安装数据库软件，并且将<code>dev</code>组主机的软件更新至最新。</p>
<blockquote>
<p>安装和更新软件需要使用<code>yum</code>模块。先看一下帮助信息中的示例吧</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# ansible-doc yum
&gt; YUM    (/usr/lib/python3.6/site-packages/ansible/modules/packaging/os/yum.py)

        Installs, upgrade, downgrades, removes, and lists packages and
        groups with the `yum&#39; package manager. This module only works
        on Python 2. If you require Python 3 support see the [dnf]
        module.

  * This module is maintained by The Ansible Core Team
  * note: This module has a corresponding action plugin.

………………省略部分输出信息………………

EXAMPLES:

- name: install the latest version of Apache
  yum:
    name: httpd
    state: latest
</code></pre>
<p>在配置<code>Ansible</code>剧本文件时，<code>ansible-doc</code>命令提供的帮助信息真是好用。在知道<code>yum</code>模块的使用方法和格</p>
<p>式后，就可以开始编写剧本了。初次编写剧本文件时，请务必看准<strong>格式，模块及<code>play</code>（动作）格式也要上下</strong></p>
<p><strong>对齐</strong>，否则会出现“参数一模一样，但不能执行”的情况。</p>
<blockquote>
<p>一个剧本正确的写法应该是</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# vim packages.yml
---
- name: 安装软件包
  hosts: dev,test,prod
  tasks:
          - name: one
            yum:
                    name: mariadb
                    state: latest
[root@linuxprobe ~]#
</code></pre>
<p>其中，<code>name</code>字段表示此项<code>play</code>（动作）的名字，用于在执行过程中提示用户执行到了哪一步，以及帮助管</p>
<p>理员在日后阅读时能想起这段代码的作用。大家可以在<code>name</code>字段自行命名，没有任何限制。<code>hosts</code>字段表示</p>
<p>要在哪些主机上执行该剧本，多个主机组之间用逗号间隔；如果需要对全部主机进行操作，则使用<code>all</code>参</p>
<p>数。<code>tasks</code>字段用于定义要执行的任务，每个任务都要有一个独立的<code>name</code>字段进行命名，并且每个任务的</p>
<p><code>name</code>字段和模块名称都要严格上下对齐，参数要单独缩进。</p>
<blockquote>
<p>而错误的剧本文件是下面这样的</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# vim packages.yml
---
- name: 安装软件包
  hosts: dev,test,prod
  tasks:
          - name: one
            yum:
            name: mariadb
            state: latest
</code></pre>
<blockquote>
<p>在编写<code>Ansible</code>剧本文件时，<code>RHEL 8</code>系统自带的<code>Vim</code>编辑器具有自动缩进功能，这可以给我们提供很多</p>
<p>帮助。在确认无误后就可以用<code>ansible-playbook</code>命令运行这个剧本文件了</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# ansible-playbook packages.yml 

PLAY [安装软件包] *******************************************************************

TASK [Gathering Facts] **************************************************************
ok: [192.168.10.20]
ok: [192.168.10.21]
ok: [192.168.10.22]
ok: [192.168.10.23]

TASK [one] **************************************************************************
changed: [192.168.10.20]
changed: [192.168.10.21]
changed: [192.168.10.22]
changed: [192.168.10.23]

PLAY RECAP **************************************************************************
192.168.10.20  : ok=2   changed=1  unreachable=0   failed=0   skipped=0   rescued=0   ignored=0   
192.168.10.21  : ok=2   changed=1  unreachable=0   failed=0   skipped=0   rescued=0   ignored=0   
192.168.10.22  : ok=2   changed=1  unreachable=0   failed=0   skipped=0   rescued=0   ignored=0   
192.168.10.23  : ok=2   changed=1  unreachable=0   failed=0   skipped=0   rescued=0   ignored=0 
</code></pre>
<p>在执行成功后，我们主要观察最下方的输出信息。其中，<code>ok</code>和<code>changed</code>表示执行及修改成功。如遇到</p>
<p><code>unreachable</code>或<code>failed</code>大于0的情况，建议手动检查剧本是否在所有主机中都正确运行了，以及有无安装失</p>
<p>败的情况。在正确执行过<code>packages.yml</code>文件后，随机切换到<code>dev</code>、<code>test</code>、<code>prod</code>组中的任意一台主机上，再</p>
<p>次安装<code>mariadb</code>软件包，此时会提示该服务已经存在。这说明刚才的操作一切顺利！</p>
<pre><code class="bash">[root@linuxprobe ~]# dnf install mariadb
Updating Subscription Management repositories.
Unable to read consumer identity
This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.
Last metadata expiration check: 1:05:53 ago on Thu 15 Apr 2021 08:29:11 AM CST.
Package mariadb-3:10.3.11-1.module+el8+2765+cfa4f87b.x86_64 is already installed.
Dependencies resolved.
Nothing to do.
Complete!
</code></pre>
<h3 id="17-5、创建以及使用角色"><a href="#17-5、创建以及使用角色" class="headerlink" title="17.5、创建以及使用角色"></a>17.5、创建以及使用角色</h3><p>在日常编写剧本时，会存在剧本越来越长的情况，这不利于进行阅读和维护，而且还无法让其他剧本灵活地调</p>
<p>用其中的功能代码。角色（<code>role</code>）这一功能则是自<code>Ansible 1.2</code>版本开始引入的新特性，用于层次性、结构</p>
<p>化地组织剧本。角色功能分别把变量、文件、任务、模块及处理器配置放在各个独立的目录中，然后对其进行</p>
<p>便捷加载。简单来说，角色功能是把常用的一些功能“类模块化”，然后在用的时候加载即可。</p>
<p>角色的好处就在于<strong>将剧本组织成了一个简洁的、可重复调用的抽象对象，使得用户把注意力放到剧本的宏观大</strong></p>
<p><strong>局上，统筹各个关键性任务，只有在需要时才去深入了解细节。</strong>角色的获取有3种方法，分别是<strong>加载系统内置</strong></p>
<p><strong>角色</strong>、<strong>从外部环境获取角色</strong>以及<strong>自行创建角色</strong>。</p>
<h4 id="17-5-1、加载系统内置角色"><a href="#17-5-1、加载系统内置角色" class="headerlink" title="17.5.1、加载系统内置角色"></a>17.5.1、加载系统内置角色</h4><p>在使用<code>RHEL</code>系统的内置角色时，我们不需要联网就能实现。用户只需要配置好软件仓库的配置文件，然后安</p>
<p>装包含系统角色的软件包<code>rhel-system-roles</code>，随后便可以在系统中找到它们了，然后就能够使用剧本文件</p>
<p>调用角色了。</p>
<pre><code class="bash">[root@linuxprobe ~]# yum install -y rhel-system-roles
Updating Subscription Management repositories.
Unable to read consumer identity
This system is not registered to Red Hat Subscription Management. You can use subscription-manager to register.
Last metadata expiration check: 1:06:26 ago on Tue 13 Apr 2021 07:22:03 AM CST.
Dependencies resolved.
================================================================================
 Package                  Arch          Version          Repository        Size
================================================================================
Installing:
 rhel-system-roles        noarch        1.0-5.el8        AppStream        127 k

Transaction Summary
================================================================================
Install  1 Package

………………省略部分输出信息………………  

Installed:
  rhel-system-roles-1.0-5.el8.noarch                                            

Complete!
</code></pre>
<p>安装完毕后，使用<code>ansible-galaxy list</code>命令查看<code>RHEL 8</code>系统中有哪些自带的角色可用：</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-galaxy list
# /usr/share/ansible/roles
- linux-system-roles.kdump, (unknown version)
- linux-system-roles.network, (unknown version)
- linux-system-roles.postfix, (unknown version)
- linux-system-roles.selinux, (unknown version)
- linux-system-roles.timesync, (unknown version)
- rhel-system-roles.kdump, (unknown version)
- rhel-system-roles.network, (unknown version)
- rhel-system-roles.postfix, (unknown version)
- rhel-system-roles.selinux, (unknown version)
- rhel-system-roles.timesync, (unknown version)
# /etc/ansible/roles
[WARNING]: - the configured path /root/.ansible/roles does not exist.
</code></pre>
<blockquote>
<p><code> ansible</code>系统角色描述</p>
</blockquote>
<table>
<thead>
<tr>
<th>角色名称</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>rhel-system-roles.kdump</td>
<td>配置kdump崩溃恢复服务</td>
</tr>
<tr>
<td>rhel-system-roles.network</td>
<td>配置网络接口</td>
</tr>
<tr>
<td>rhel-system-roles.selinux</td>
<td>配置SELinux策略及模式</td>
</tr>
<tr>
<td>rhel-system-roles.timesync</td>
<td>配置网络时间协议</td>
</tr>
<tr>
<td>rhel-system-roles.postfix</td>
<td>配置邮件传输服务</td>
</tr>
<tr>
<td>rhel-system-roles.firewall</td>
<td>配置防火墙服务</td>
</tr>
<tr>
<td>rhel-system-roles.tuned</td>
<td>配置系统调优选项</td>
</tr>
</tbody></table>
<p>以<code>rhel-system-roles.timesync</code>角色为例，它用于设置系统的时间和<code>NTP</code>服务，让主机能够同步准确的时</p>
<p>间信息。剧本模板文件存放在<code>/usr/share/doc/rhel-system-roles/</code>目录中，可以复制过来修改使用</p>
<pre><code class="bash">[root@linuxprobe ~]# cp /usr/share/doc/rhel-system-roles/timesync/example-timesync-playbook.yml timesync.yml
</code></pre>
<p><code>NTP</code>服务器主要用于同步计算机的时间，可以提供高精度的时间校准服务，帮助计算机校对系统时钟。在复</p>
<p>制来的剧本模板文件中，删除掉多余的代码，将<code>NTP</code>服务器的地址填写到<code>timesync_ntp_servers</code>变量的</p>
<p><code>hostname</code>字段中即可。该变量的参数含义如表所示。稍后<code>timesync</code>角色就会自动为用户配置参数信息了。</p>
<blockquote>
<p><code> timesync_ntp_servers</code>变量参数含义</p>
</blockquote>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>hostname</td>
<td>NTP服务器主机名</td>
</tr>
<tr>
<td>iburst</td>
<td>启用快速同步</td>
</tr>
</tbody></table>
<pre><code class="bash">[root@linuxprobe ~]# vim timesync.yml 
---
- hosts: all
  vars:
    timesync_ntp_servers:
      - hostname: pool.ntp.org
        iburst: yes
  roles:
    - rhel-system-roles.timesync
</code></pre>
<h4 id="17-5-2、从外部获取角色"><a href="#17-5-2、从外部获取角色" class="headerlink" title="17.5.2、从外部获取角色"></a>17.5.2、从外部获取角色</h4><p><code>Ansible Galaxy</code>是<code>Ansible</code>的一个官方社区，用于共享角色和功能代码，用户可以在网站自由地共享和下</p>
<p>载<code>Ansible</code>角色。该社区是管理和使用角色的不二之选。</p>
<p>在图17-4所示的<code>Ansible Galaxy</code>官网中，左侧有3个功能选项，分别是首页（<code>Home</code>）、搜索（<code>Search</code>）以</p>
<p>及社区（<code>Community</code>）。单击<code>Search</code>按钮进入到搜索界面，这里以<code>nginx</code>服务为例进行搜索，即可找到</p>
<p><code>Nginx</code>官方发布的角色信息，如图17-5所示。</p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825094820600.png" alt="图 17-4 Ansible Galaxy 官网首页"></p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825094837843.png" alt="图17-5 搜索界面中找到nginx角色信息"></p>
<blockquote>
<p><code>Ansible Galaxy </code>官网首页：<a target="_blank" rel="noopener" href="https://galaxy.ansible.com/">https://galaxy.ansible.com</a></p>
</blockquote>
<p>当单击<code>nginx</code>角色进入到详情页面后，会显示这个项目的软件版本、评分、下载次数等信息。在</p>
<p><code>Installation</code>字段可以看到相应的安装方式，如图17-6所示。在保持虚拟机能够连接外网的前</p>
<p>提下，可以按这个页面提示的命令进行安装。</p>
<p>这时，如果需要使用这个角色，可以在虚拟机联网的状态下直接按照“<code>ansible-galaxy install</code>角色名</p>
<p>称”的命令格式自动获取</p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825095011807.png" alt="图17-6 nginx角色详情页"></p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-galaxy install nginxinc.nginx
- downloading role &#39;nginx&#39;, owned by nginxinc
- downloading role from https://github.com/nginxinc/ansible-role-nginx/archive/0.19.1.tar.gz
- extracting nginxinc.nginx to /etc/ansible/roles/nginxinc.nginx
- nginxinc.nginx (0.19.1) was installed successfully
</code></pre>
<p>执行完毕后，再次查看系统中已有的角色，便可找到<code>nginx</code>角色信息了</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-galaxy list
# /etc/ansible/roles
- nginxinc.nginx, 0.19.1
# /usr/share/ansible/roles
- linux-system-roles.kdump, (unknown version)
- linux-system-roles.network, (unknown version)
- linux-system-roles.postfix, (unknown version)
- linux-system-roles.selinux, (unknown version)
- linux-system-roles.timesync, (unknown version)
- rhel-system-roles.kdump, (unknown version)
- rhel-system-roles.network, (unknown version)
- rhel-system-roles.postfix, (unknown version)
- rhel-system-roles.selinux, (unknown version)
- rhel-system-roles.timesync, (unknown version)
</code></pre>
<blockquote>
<p>这里还存在两种特殊情况：</p>
<ul>
<li><strong>在国内访问<code>Ansible Galaxy</code>官网时可能存在不稳定的情况，导致访问不了或者网速较慢。</strong></li>
<li><strong>某位作者是将作品上传到了自己的网站，或者除<code>Ansible Galaxy</code>官网以外的其他平台。</strong></li>
</ul>
</blockquote>
<p>在这两种情况下，就不能再用“<code>ansible-galaxy install</code>角色名称”的命令直接加载了，而是需要手动先编</p>
<p>写一个<code>YAML</code>语言格式的文件，指明网址链接和角色名称，然后再用<code>-r</code>参数进行加载。</p>
<p>例如，刘遄老师在套网站（<a target="_blank" rel="noopener" href="http://www.linuxprobe.com)上传了一个名为`nginx_core`的角色软件包(一个用于对/">www.linuxprobe.com）上传了一个名为`nginx_core`的角色软件包（一个用于对</a></p>
<p><code>nginx</code>网站进行保护的插件）。这时需要编写如下所示的一个<code>yml</code>配置文件</p>
<pre><code class="bash">[root@linuxprobe ~]# cat nginx.yml
---
- src: https://www.linuxprobe.com/Software/nginxinc-nginx_core-0.3.0.tar.gz
  name: nginx-core
</code></pre>
<p>随后使用<code>ansible-galaxy</code>命令的<code>-r</code>参数加载这个文件，即可查看到新角色信息了</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-galaxy install -r nginx.yml
- downloading role from https://www.linuxprobe.com/nginxinc-nginx_core-0.3.0.tar.gz
- extracting nginx to /etc/ansible/roles/nginx
- nginx was installed successfully
[root@linuxprobe ~]# ansible-galaxy list
# /etc/ansible/roles
- nginx-core, (unknown version)
- nginxinc.nginx, 0.19.1
# /usr/share/ansible/roles
- linux-system-roles.kdump, (unknown version)
- linux-system-roles.network, (unknown version)
- linux-system-roles.postfix, (unknown version)
- linux-system-roles.selinux, (unknown version)
- linux-system-roles.timesync, (unknown version)
- rhel-system-roles.kdump, (unknown version)
- rhel-system-roles.network, (unknown version)
- rhel-system-roles.postfix, (unknown version)
- rhel-system-roles.selinux, (unknown version)
- rhel-system-roles.timesync, (unknown version)
</code></pre>
<h4 id="17-5-3、创建新的角色"><a href="#17-5-3、创建新的角色" class="headerlink" title="17.5.3、创建新的角色"></a>17.5.3、创建新的角色</h4><p>创建一个名为<code>apache</code>的新角色，它能够帮助我们自动安装、运行<code>httpd</code>网站服务，设置防火墙的允许规则，</p>
<p>以及根据每个主机生成独立的<code>index.html</code>首页文件。用户在调用这个角色后能享受到“一条龙”的网站部署服</p>
<p>务。</p>
<p>在<code>Ansible</code>的主配置文件中，第68行定义的是角色保存路径。如果用户新建的角色信息不在规定的目录内，</p>
<p>则无法使用<code>ansible-galaxy list</code>命令找到。因此需要手动填写新角色的目录路径，或是进</p>
<p>入<code>/etc/ansible/roles</code>目录内再进行创建。为了避免后期角色信息过于分散导致不好管理，我们还是决定</p>
<p>在默认目录下进行创建，不再修改。</p>
<pre><code class="bash">[root@linuxprobe roles]# vim /etc/ansible/ansible.cfg
 66 
 67 # additional paths to search for roles in, colon separated
 68 #roles_path    = /etc/ansible/roles
 69 
</code></pre>
<p>在<code>ansible-galaxy</code>命令后面跟一个<code>init</code>参数，创建一个新的角色信息，且建立成功后便会在当前目录下生</p>
<p>成出一个新的目录</p>
<pre><code class="bash">[root@linuxprobe ~]# cd /etc/ansible/roles
[root@linuxprobe roles]# ansible-galaxy init apache
- Role apache was created successfully
[root@linuxprobe roles]# ls
apache nginx nginxinc.nginx
</code></pre>
<p>此时的<code>apache</code>即是角色名称，也是用于存在角色信息的目录名称。切换到该目录下，查看它的结构</p>
<pre><code class="bash">[root@linuxprobe roles]# cd apache
[root@linuxprobe apache]# ls
defaults  files  handlers  meta  README.md  tasks  templates  tests  vars
</code></pre>
<blockquote>
<p><code>Ansible</code>角色目录结构及含义</p>
</blockquote>
<table>
<thead>
<tr>
<th>目录</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>defaults</td>
<td>包含角色变量的默认值（优先级低）。</td>
</tr>
<tr>
<td>files</td>
<td>包含角色执行tasks任务时做引用的静态文件。</td>
</tr>
<tr>
<td>handlers</td>
<td>包含角色的处理程序定义。</td>
</tr>
<tr>
<td>meta</td>
<td>包含角色的作者、许可证、频台和依赖关系等信息。</td>
</tr>
<tr>
<td>tasks</td>
<td>包含角色所执行的任务。</td>
</tr>
<tr>
<td>templates</td>
<td>包含角色任务所使用的Jinja2模板。</td>
</tr>
<tr>
<td>tests</td>
<td>包含用于测试角色的剧本文件。</td>
</tr>
<tr>
<td>vars</td>
<td>包含角色变量的默认值（优先级高）。</td>
</tr>
</tbody></table>
<blockquote>
<p> 下面准备创建新角色。</p>
</blockquote>
<blockquote>
<p><strong>第1步</strong>：打开用于定义角色任务的<code>tasks/main.yml</code>文件。在该文件中不需要定义要执行的主机组列表，</p>
<p>因为后面会单独编写剧本进行调用，此时应先对<code>apache</code>角色能做的事情（任务）有一个明确的思路，在</p>
<p>调用角色后<code>yml</code>文件会按照从上到下的顺序自动执行：</p>
<p><strong>任务1</strong>：安装httpd网站服务。</p>
<p><strong>任务2</strong>：运行httpd网站服务，并加入到开机启动项中。</p>
<p><strong>任务3</strong>：配置防火墙，使其放行HTTP协议。</p>
<p><strong>任务4</strong>：根据每台主机的变量值，生成不同的主页文件。</p>
</blockquote>
<blockquote>
<p>先写出第一个任务。使用<code>yum</code>模块安装httpd网站服务程序（注意格式）</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe apache]# vim tasks/main.yml
---
- name: one
  yum:
          name: httpd
          state: latest
</code></pre>
<blockquote>
<p><strong>第2步</strong>：使用<code>service</code>模块启动<code>httpd</code>网站服务程序，并加入到启动项中，保证能够一直为用户提供服</p>
<p>务。在初次使用模块前，先用<code>ansible-doc</code>命令查看一下帮助和实例信息。由于篇幅的限制，这里对信</p>
<p>息进行了删减，仅保留了有用的内容。</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe apache]# ansible-doc service
&gt; SERVICE    (/usr/lib/python3.6/site-packages/ansible/modules/system/service.py)

        Controls services on remote hosts. Supported init systems
        include BSD init, OpenRC, SysV, Solaris SMF, systemd, upstart.
        For Windows targets, use the [win_service] module instead.

  * This module is maintained by The Ansible Core Team
  * note: This module has a corresponding action plugin.

………………省略部分输出信息………………

EXAMPLES:

- name: Start service httpd, if not started
  service:
    name: httpd
    state: started

- name: Enable service httpd, and not touch the state
  service:
    name: httpd
    enabled: yes
</code></pre>
<p>真幸运，默认的<code>EXAMPLES示</code>例使用的就是<code>httpd</code>网站服务。通过输出信息可得知，启动服务为“state: </p>
<p>started”参数，而加入到开机启动项则是“enabled: yes”参数。继续编写</p>
<pre><code class="bash">[root@linuxprobe apache]# vim tasks/main.yml
---
- name: one
  yum:
          name: httpd
          state: latest
- name: two
  service:
          name: httpd
          state: started
          enabled: yes
</code></pre>
<blockquote>
<p><strong>第3步</strong>：配置防火墙的允许策略，让其他主机可以正常访问。在配置防火墙时，需要使用<code>firewalld</code></p>
<p>模块。同样也是先看一下帮助示例</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe defaults]# ansible-doc firewalld
&gt; FIREWALLD    (/usr/lib/python3.6/site-packages/ansible/modules/system/firewalld.py)

        This module allows for addition or deletion of services and
        ports (either TCP or UDP) in either running or permanent
        firewalld rules.

  * This module is maintained by The Ansible Community
OPTIONS (= is mandatory):
EXAMPLES:

- firewalld:
    service: https
    permanent: yes
    state: enabled

- firewalld:
    port: 8081/tcp
    permanent: yes
    state: disabled
    immediate: yes
</code></pre>
<p>依据输出信息可得知，在<code>firewalld</code>模块设置防火墙策略时，指定协议名称为“<code>service: http</code>”参数，放行</p>
<p>该协议为“<code>state: enabled</code>”参数，设置为永久生效为“<code>permanent: yes</code>”参数，当前立即生效</p>
<p>为“<code>immediate: yes</code>”参数。</p>
<pre><code class="bash">[root@linuxprobe apache]# vim tasks/main.yml
---
- name: one
  yum:
          name: httpd
          state: latest
- name: two
  service:
          name: httpd
          state: started
          enabled: yes
- name: three
  firewalld:
          service: http
          permanent: yes
          state: enabled
          immediate: yes
</code></pre>
<blockquote>
<p><strong>第4步</strong>：让每台主机显示的主页文件均不相同。在使用<code>Ansible</code>的常规模块时，都是采用“查询版主示例</p>
<p>并模仿”的方式搞定的，这里为了增加难度，我们再提出个新需求，<strong>即能否让每台主机上运行的httpd网</strong></p>
<p><strong>站服务都能显示不同的内容呢？例如显示当前服务器的主机名及IP地址。这就要用到template模块及</strong></p>
<p><strong>Jinja2技术了。</strong></p>
<p>我们依然使用<code>ansible-doc</code>命令来查询<code>template</code>模块的使用方法。示例部分依然大有帮助</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe apache]# ansible-doc template
&gt; TEMPLATE    (/usr/lib/python3.6/site-packages/ansible/modules/files/template.&gt;

        Templates are processed by the L(Jinja2 templating
        language,http://jinja.pocoo.org/docs/). Documentation on the
        template formatting can be found in the L(Template Designer
        Documentation,http://jinja.pocoo.org/docs/templates/).
        Additional variables listed below can be used in templates.
        `ansible_managed&#39; (configurable via the `defaults&#39; section of
        `ansible.cfg&#39;) contains a string which can be used to describe
        the template name, host, modification time of the template
        file and the owner uid. `template_host&#39; contains the node name
        of the template&#39;s machine. `template_uid&#39; is the numeric user
        id of the owner. `template_path&#39; is the path of the template.
        `template_fullpath&#39; is the absolute path of the template.
        `template_destpath&#39; is the path of the template on the remote
        system (added in 2.8). `template_run_date&#39; is the date that
        the template was rendered.

  * This module is maintained by The Ansible Core Team
  * note: This module has a corresponding action plugin.

………………省略部分输出信息………………

EXAMPLES:

- name: Template a file to /etc/files.conf
  template:
    src: /mytemplates/foo.j2
    dest: /etc/file.conf
    owner: bin
    group: wheel
    mode: &#39;0644&#39;
</code></pre>
<p>从<code>template</code>模块的输出信息中可得知，这是一个用于复制文件模板的模块，能够把文件从<code>Ansible</code>服务器复</p>
<p>制到受管主机上。其中，<code>src</code>参数用于定义本地文件的路径，<code>dest</code>参数用于定义复制到受管主机的文件路</p>
<p>径，而<code>owner</code>、<code>group</code>、<code>mode</code>参数可选择性地设置文件归属及权限信息。</p>
<p>正常来说，我们可以直接复制文件的操作，受管主机上会获取到一个与<code>Ansible</code>服务器上的文件一模一样的</p>
<p>文件。但有时候，我们想让每台客户端根据自身系统的情况产生不同的文件信息，这就需要用到<code>Jinja2</code>技</p>
<p>术了，<code>Jinja2</code>格式的模板文件后缀是.j2。继续编写</p>
<pre><code class="bash">[root@linuxprobe apache]# vim tasks/main.yml
---
- name: one
  yum:
          name: httpd
          state: latest
- name: two
  service:
          name: httpd
          state: started
          enabled: yes
- name: three
  firewalld:
          service: http
          permanent: yes
          state: enabled
          immediate: yes
- name: four
  template:
          src: index.html.j2
          dest: /var/www/html/index.html
</code></pre>
<p><code>Jinja2</code>是<code>Python</code>语言中一个被广泛使用的模板引擎，最初的设计思想源自<code>Django</code>的模块引擎。<code>Jinja2</code>基</p>
<p>于此发展了其语法和一系列强大的功能，能够让受管主机根据自身变量产生出不同的文件内容。换句话说，正</p>
<p>常情况下的复制操作会让新旧文件一模一样，但在使用<code>Jinja2</code>技术时，不是在原始文件中直接写入文件内</p>
<p>容，而是写入一系列的变量名称。在使用<code>template</code>模块进行复制的过程中，由<code>Ansible</code>服务负责在受管主机</p>
<p>上收集这些变量名称所对应的值，然后再逐一填写到目标文件中，从而让每台主机的文件都根据自身系统的情</p>
<p>况独立生成。</p>
<p>例如，想要让每个网站的输出信息值为“<code>Welcome to</code>主机名<code>on</code>主机地址”，也就是用每个主机自己独有的名称</p>
<p>和IP地址来替换文本中的内容，这样就有趣太多了。这个实验的难点在于查询到对应的变量名称、主机名及地</p>
<p>址所对应的值保存在哪里？可以用<code>setup</code>模块进行查询。</p>
<pre><code>[root@linuxprobe apache]# ansible-doc setup
&gt; SETUP    (/usr/lib/python3.6/site-packages/ansible/modules/system/setup.py)

        This module is automatically called by playbooks to gather
        useful variables about remote hosts that can be used in
        playbooks. It can also be executed directly by
        `/usr/bin/ansible&#39; to check what variables are available to a
        host. Ansible provides many `facts&#39; about the system,
        automatically. This module is also supported for Windows
        targets.
</code></pre>
<p><code>setup</code>模块的作用是自动收集受管主机上的变量信息，使用<code>-a</code>参数外加<code>filter</code>命令可以对收集来的信息进</p>
<p>行二次过滤。相应的语法格式为<code>ansible all -m setup -a</code> ‘<code>filter</code>&#x3D;”<em>关键词</em>“‘，其中*号是第4章节讲到的</p>
<p>通配符，用于进行关键词查询。例如，如果想搜索各个主机的名称，可以使用通配符搜索所有包含<code>fqdn</code>关键</p>
<p>词的变量值信息。</p>
<p><code>FQDN</code>（<code>Fully Qualified Domain Name</code>，完全限定域名）用于在逻辑上准确表示出主机的位置。<code>FQDN</code>常</p>
<p>常被作为主机名的完全表达形式，比<code>/etc/hostname</code>文件中定义的主机名更加严谨和准确。通过输出信息可</p>
<p>得知，<code>ansible_fqdn</code>变量保存有主机名称。随后进行下一步操作</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible all -m setup -a &#39;filter=&quot;*fqdn*&quot;&#39;
192.168.10.20 | SUCCESS =&gt; &#123;
    &quot;ansible_facts&quot;: &#123;
        &quot;ansible_fqdn&quot;: &quot;linuxprobe.com&quot;,
        &quot;discovered_interpreter_python&quot;: &quot;/usr/libexec/platform-python&quot;
    &#125;,
    &quot;changed&quot;: false
&#125;
………………省略部分输出信息………………
</code></pre>
<p>用于指定主机地址的变量可以用<code>ip</code>作为关键词进行检索。可以看到，<code>ansible_all_ipv4_addresses</code>变量中</p>
<p>的值是我们想要的信息。如果想输出<code>IPv6</code>形式的地址，则可用<code>ansible_all_ipv6_addresses</code>变量</p>
<pre><code>[root@linuxprobe ~]# ansible all -m setup -a &#39;filter=&quot;*ip*&quot;&#39;
192.168.10.20 | SUCCESS =&gt; &#123;
    &quot;ansible_facts&quot;: &#123;
        &quot;ansible_all_ipv4_addresses&quot;: [
            &quot;192.168.10.20&quot;,
            &quot;192.168.122.1&quot;
        ],
        &quot;ansible_all_ipv6_addresses&quot;: [
            &quot;fe80::d0bb:17c8:880d:e719&quot;
        ],
        &quot;ansible_default_ipv4&quot;: &#123;&#125;,
        &quot;ansible_default_ipv6&quot;: &#123;&#125;,
        &quot;ansible_fips&quot;: false,
        &quot;discovered_interpreter_python&quot;: &quot;/usr/libexec/platform-python&quot;
    &#125;,
    &quot;changed&quot;: false
&#125;
………………省略部分输出信息………………
</code></pre>
<p>在确认了主机名与IP地址所对应的具体变量名称后，在角色所对应的<code>templates</code>目录内新建一个与上面的</p>
<p><code>template</code>模块参数相同的文件名称（<code>index.html.j2</code>）。<code>Jinja2</code>在调用变量值时，格式为在变量名称的两</p>
<p>侧格加两个大括号</p>
<pre><code class="bash">[root@linuxprobe apache]# vim templates/index.html.j2
Welcome to &#123;&#123; ansible_fqdn &#125;&#125; on &#123;&#123; ansible_all_ipv4_addresses &#125;&#125;
</code></pre>
<p>进行到这里，任务基本就算完成了。最后要做的就是编写一个用于调用<code>apache</code>角色的<code>yml</code>文件，以及执行</p>
<p>这个文件。</p>
<pre><code class="bash">[root@linuxprobe apache]# cd ~
[root@linuxprobe ~]# vim roles.yml
---
- name: 调用自建角色
  hosts: all
  roles:
          - apache
[root@linuxprobe ~]# ansible-playbook roles.yml 
PLAY [调用自建角色] **************************************************************************

TASK [Gathering Facts] **********************************************************************
ok: [192.168.10.20]
ok: [192.168.10.21]
ok: [192.168.10.22]
ok: [192.168.10.23]
ok: [192.168.10.24]

TASK [apache : one] *************************************************************************
changed: [192.168.10.20]
changed: [192.168.10.21]
changed: [192.168.10.22]
changed: [192.168.10.23]
changed: [192.168.10.24]

TASK [apache : two] *************************************************************************
changed: [192.168.10.20]
changed: [192.168.10.21]
changed: [192.168.10.22]
changed: [192.168.10.23]
changed: [192.168.10.24]

TASK [apache : three] ***********************************************************************
changed: [192.168.10.20]
changed: [192.168.10.21]
changed: [192.168.10.22]
changed: [192.168.10.23]
changed: [192.168.10.24]

TASK [apache : four] ***********************************************************************
changed: [192.168.10.20]
changed: [192.168.10.21]
changed: [192.168.10.22]
changed: [192.168.10.23] 
changed: [192.168.10.24]

PLAY RECAP **********************************************************************************
192.168.10.20   : ok=5   changed=4  unreachable=0   failed=0   skipped=0   rescued=0   ignored=0   
192.168.10.21   : ok=5   changed=4  unreachable=0   failed=0   skipped=0   rescued=0   ignored=0   
192.168.10.22   : ok=5   changed=4  unreachable=0   failed=0   skipped=0   rescued=0   ignored=0   
192.168.10.23   : ok=5   changed=4  unreachable=0   failed=0   skipped=0   rescued=0   ignored=0   
192.168.10.24   : ok=4   changed=4  unreachable=0   failed=0   skipped=0   rescued=0   ignored=0
</code></pre>
<p>执行完毕后，在浏览器中随机输入几台主机的IP地址，即可访问到包含主机<code>FQDN</code>和<code>IP</code>地址的网页了，如图</p>
<p>17-7～图17-9所示。</p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825105529565.png" alt="图17-7 随机访问一台主机节点的网站首页"></p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825105540310.png" alt="图17-8 随机访问一台主机节点的网站首页"></p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825105556834.png" alt="图17-9 随机访问一台主机节点的网站首页"></p>
<h3 id="17-6、创建和使用逻辑卷"><a href="#17-6、创建和使用逻辑卷" class="headerlink" title="17.6、创建和使用逻辑卷"></a>17.6、创建和使用逻辑卷</h3><blockquote>
<p>创建一个能批量、自动管理逻辑卷设备的剧本，不但能大大提高硬盘设备的管理效率，而且还能避免手</p>
<p>动创建带来的错误。例如，我们想在每台受管主机上都创建出一个名为<code>data</code>的逻辑卷设备，大小为</p>
<p>150MB，归属于<code>research</code>卷组。如果创建成功，则进一步用Ext4文件系统进行格式化操作；如果创建</p>
<p>失败，则给用户输出一条报错提醒，以便排查原因。</p>
<p>在这种情况下，使用Ansible剧本要比使用Shell脚本的优势大，原因主要有下面两点：</p>
<ul>
<li><strong><code>Ansible</code>模块化的功能让操作更标准，只要在执行过程中无报错，那么便会依据远程主机的系统版本及配置自动做出判断和操作，不用担心因系统变化而导致命令失效的问题。</strong></li>
<li><strong><code>Ansible</code>服务在执行剧本文件时会进行判断：如果该文件或该设备已经被创建过，或是某个动作（play）已经被执行过，则绝对不会再重复执行；而使用Shell脚本有可能导致设备被重复格式化，导致数据丢失。</strong></li>
</ul>
</blockquote>
<p>首先在<code>prod</code>组的两台主机上分别添加一块硬盘设备，大小为20GB，类型为SCSI，其余选项选择默认值，如</p>
<p>图17-10～图17-12所示。</p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825105807981.png" alt="图17-10 添加一块新硬盘"></p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825105821291.png" alt="图17-11 设置硬盘类型"></p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825105836257.png" alt="图17-12 新硬盘添加完毕"></p>
<p>通过回忆第7章学习过的逻辑卷的知识，我们应该让剧本文件依次创建物理卷（PV）、卷组（VG）及逻辑卷</p>
<p>（LV）。需要先使用lvg模块让设备支持逻辑卷技术，然后创建一个名为research的卷组。lvg模块的帮助信息</p>
<p>如下</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-doc lvg
&gt; LVG    (/usr/lib/python3.6/site-packages/ansible/modules/system/lvg.py)

        This module creates, removes or resizes volume groups.

  * This module is maintained by The Ansible Community

………………省略部分输出信息………………

EXAMPLES:

- name: Create a volume group on top of /dev/sda1 with physical extent size = 3&gt;
  lvg:
    vg: vg.services
    pvs: /dev/sda1
    pesize: 32

- name: Create a volume group on top of /dev/sdb with physical extent size = 12&gt;
  lvg:
    vg: vg.services
    pvs: /dev/sdb
    pesize: 128K
</code></pre>
<p>通过输出信息可得知，创建<code>PV</code>和<code>VG</code>的<code>lvg</code>模块总共有3个必备参数。其中，<code>vg</code>参数用于定义卷组的名称，</p>
<p><code>pvs</code>参数用于指定硬盘设备的名称，<code>pesize</code>参数用于确定最终卷组的容量大小（可以用PE个数或容量值进行</p>
<p>指定）。这样一来，我们先创建出一个由<code>/dev/sdb</code>设备组成的名称为<code>research</code>、大小为150MB的卷组设</p>
<p>备。</p>
<pre><code class="bash">[root@linuxprobe ~]# vim lv.yml
---
- name: 创建和使用逻辑卷
  hosts: all
  tasks:
          - name: one
            lvg:
                    vg: research
                    pvs: /dev/sdb
                    pesize: 150M
</code></pre>
<p>由于刚才只在<code>prod</code>组的两台主机上添加了新硬盘设备文件，因此在执行上述操作时其余3台主机会提示未创</p>
<p>建成功，这属于正常情况。接下来使用<code>lvol</code>模块创建出逻辑卷设备。还是按照惯例，先查看模块的帮助信息</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-doc lvol
&gt; LVOL    (/usr/lib/python3.6/site-packages/ansible/modules/system/lvol.py)

        This module creates, removes or resizes logical volumes.

  * This module is maintained by The Ansible Community

………………省略部分输出信息………………

EXAMPLES:

- name: Create a logical volume of 512m
  lvol:
    vg: firefly
    lv: test
    size: 512

- name: Create a logical volume of 512m with disks /dev/sda and /dev/sdb
  lvol:
    vg: firefly
    lv: test
    size: 512
    pvs: /dev/sda,/dev/sdb
</code></pre>
<p>通过输出信息可得知，<code>lvol</code>是用于创建逻辑卷设备的模块。其中，<code>vg</code>参数用于指定卷组名称，<code>lv</code>参数用于</p>
<p>指定逻辑卷名称，<code>size</code>参数则用于指定最终逻辑卷设备的容量大小（不用加单位，默认为MB）。填写好参</p>
<p>数，创建出一个大小为150MB、归属于research卷组且名称为data的逻辑卷设备</p>
<pre><code class="bash">[root@linuxprobe ~]# vim lv.yml
---
- name: 创建和使用逻辑卷
  hosts: all
  tasks:
          - name: one
            lvg:
                    vg: research
                    pvs: /dev/sdb
                    pesize: 150M
          - name: two
            lvol:
                    vg: research
                    lv: data
                    size: 150M
</code></pre>
<p>这样还不够好，如果还能将创建出的<code>/dev/research/data</code>逻辑卷设备自动用<code>Ext4</code>文件系统进行格式化操</p>
<p>作，则又能帮助运维管理员减少一些工作量。可使用<code>filesystem</code>模块来完成设备的文件系统格式化操作。该</p>
<p>模块的帮助信息如下</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-doc filesystem
&gt; FILESYSTEM    (/usr/lib/python3.6/site-packages/ansible/modules/system/filesy&gt;

        This module creates a filesystem.

  * This module is maintained by The Ansible Community

………………省略部分输出信息………………

EXAMPLES:

- name: Create a ext2 filesystem on /dev/sdb1
  filesystem:
    fstype: ext2
    dev: /dev/sdb1
</code></pre>
<p><code>filesystem</code>模块的参数真是简练，<code>fstype</code>参数用于指定文件系统的格式化类型，<code>dev</code>参数用于指定要格式</p>
<p>化的设备文件路径。继续编写</p>
<pre><code class="bash">---
- name: 创建和使用逻辑卷
  hosts: all
  tasks:
          - name: one
            lvg:
                    vg: research
                    pvs: /dev/sdb
                    pesize: 150M
          - name: two
            lvol:
                    vg: research
                    lv: data
                    size: 150M
          - name: three
            filesystem:
                    fstype: ext4
                    dev: /dev/research/data 
</code></pre>
<p>首先用<code>block</code>操作符将上述的3个模块命令作为一个整体（相当于对这3个模块的执行结果作为一个整体进行</p>
<p>判断），然后使用<code>rescue</code>操作符进行救援，且只有<code>block</code>块中的模块执行失败后才会调用<code>rescue</code>中的救援</p>
<p>模块。其中，<code>debug</code>模块的<code>msg</code>参数的作用是，如果<code>block</code>中的模块执行失败，则输出一条信息到屏幕，用</p>
<p>于提醒用户。完成编写后的剧本是下面这个样子</p>
<pre><code class="bash">[root@linuxprobe ~]# vim lv.yml
---
- name: 创建和使用逻辑卷
  hosts: all
  tasks:
          - block:
                  - name: one
                    lvg:
                            vg: research
                            pvs: /dev/sdb
                            pesize: 150M
                  - name: two
                    lvol:
                            vg: research
                            lv: data
                            size: 150M
                  - name: three
                    filesystem:
                            fstype: ext4
                            dev: /dev/research/data
            rescue:
                    - debug:
                            msg: &quot;Could not create logical volume of that size&quot;
</code></pre>
<p><code>YAML</code>语言对格式有着硬性的要求，既然<code>rescue</code>是对<code>block</code>内的模块进行救援的功能代码，因此<code>recue</code>和</p>
<p><code>block</code>两个操作符必须严格对齐，错开一个空格都会导致剧本执行失败。确认无误后，执行<code>lv.yml</code>剧本文件</p>
<p>检阅一下效果</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-playbook lv.yml 

PLAY [创建和使用逻辑卷] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [192.168.10.20]
ok: [192.168.10.21]
ok: [192.168.10.22]
ok: [192.168.10.23]
ok: [192.168.10.24]

TASK [one] *********************************************************************
fatal: [192.168.10.20]: FAILED! =&gt; &#123;&quot;changed&quot;: false, &quot;msg&quot;: &quot;Device /dev/sdb not found.&quot;&#125;
fatal: [192.168.10.21]: FAILED! =&gt; &#123;&quot;changed&quot;: false, &quot;msg&quot;: &quot;Device /dev/sdb not found.&quot;&#125;
changed: [192.168.10.22]
changed: [192.168.10.23]
fatal: [192.168.10.24]: FAILED! =&gt; &#123;&quot;changed&quot;: false, &quot;msg&quot;: &quot;Device /dev/sdb not found.&quot;&#125;

TASK [two] *********************************************************************
changed: [192.168.10.22]
changed: [192.168.10.23]

TASK [three] *********************************************************************
changed: [192.168.10.22]
changed: [192.168.10.23]

TASK [debug] *******************************************************************
ok: [192.168.10.20] =&gt; &#123;
    &quot;msg&quot;: &quot;Could not create logical volume of that size&quot;
&#125;
ok: [192.168.10.21] =&gt; &#123;
    &quot;msg&quot;: &quot;Could not create logical volume of that size&quot;
&#125;
ok: [192.168.10.24] =&gt; &#123;
    &quot;msg&quot;: &quot;Could not create logical volume of that size&quot;
&#125;

PLAY RECAP *********************************************************************
192.168.10.20  : ok=2  changed=0  unreachable=0  failed=0  skipped=0  rescued=1  ignored=0   
192.168.10.21  : ok=2  changed=0  unreachable=0  failed=0  skipped=0  rescued=1  ignored=0   
192.168.10.22  : ok=4  changed=3  unreachable=0  failed=0  skipped=0  rescued=0  ignored=0   
192.168.10.23  : ok=4  changed=3  unreachable=0  failed=0  skipped=0  rescued=0  ignored=0   
192.168.10.24  : ok=2  changed=0  unreachable=0  failed=0  skipped=0  rescued=1  ignored=0 
</code></pre>
<p>在剧本运行完毕后的执行记录（<code>PLAY RECAP</code>）中可以很清晰地看到只有192.168.10.22及192.168.10.23这</p>
<p>两台<code>prod</code>组中的主机执行成功了，其余3台主机均触发了<code>rescue</code>功能。登录到任意一台<code>prod</code>组的主机上，</p>
<p>找到新建的逻辑卷设备信息</p>
<pre><code class="bash">[root@linuxprobe ~]# lvdisplay 
  --- Logical volume ---
  LV Path                /dev/research/data
  LV Name                data
  VG Name                research
  LV UUID                EOUliC-tbkk-kOJR-8NaH-O9XQ-ijrK-TgEYGj
  LV Write Access        read/write
  LV Creation host, time linuxprobe.com, 2021-04-23 11:00:21 +0800
  LV Status              available
  # open                 0
  LV Size                5.00 GiB
  Current LE             1
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     8192
  Block device           253:2
………………省略部分输出信息………………
</code></pre>
<h3 id="17-7、判断主机组名"><a href="#17-7、判断主机组名" class="headerlink" title="17.7、判断主机组名"></a>17.7、判断主机组名</h3><p>在上面的剧本实验中，我们可以让不同的主机根据自身不同的变量信息而生成出独特的网站主页文件，但却无</p>
<p>法对某个主机组进行针对性的操作。其实，在每个客户端中都会有一个名为<code>inventory_hostname</code>的变量，</p>
<p>用于定义每台主机所对应的<code>Ansible</code>服务的主机组名称，也就是<code>/etc/ansible/hosts</code>文件中所对应的分组</p>
<p>信息，例如<code>dev</code>、<code>test</code>、<code>prod</code>、<code>balancers</code>。</p>
<p><code>inventory_hostname</code>是<code>Ansible</code>服务中的魔法变量，这意味着无法使用<code>setup</code>模块直接进行查询，诸如</p>
<p><code>ansible all -m setup -a</code> ‘filter&#x3D;”<em>关键词</em>“‘这样的命令将对它失效。魔法变量需要在执行剧本文件时的</p>
<p><code>Gathering Facts</code>阶段进行搜集，直接查询是看不到的，<strong>只能在剧本文件中进行调用</strong>。</p>
<blockquote>
<p>在获得了存储主机组名称的变量名称后，接下来开始实战。这里的需求如下：</p>
<ul>
<li>若主机在<code>dev</code>分组中，则修改<code>/etc/issue</code>文件内容为<code>Development</code>；</li>
<li>若主机在<code>test</code>分组中，则修改<code>/etc/issue</code>文件内容为<code>Test</code>；</li>
<li>若主机在<code>prod</code>分组中，则修改<code>/etc/issue</code>文件内容为<code>Production</code>。</li>
</ul>
</blockquote>
<blockquote>
<p>先查询<code>copy</code>模块的帮助信息</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# ansible-doc copy
&gt; COPY    (/usr/lib/python3.6/site-packages/ansible/modules/files/copy.py)

        The `copy&#39; module copies a file from the local or remote
        machine to a location on the remote machine. Use the [fetch]
        module to copy files from remote locations to the local box.
        If you need variable interpolation in copied files, use the
        [template] module. Using a variable in the `content&#39; field
        will result in unpredictable output. For Windows targets, use
        the [win_copy] module instead.

  * This module is maintained by The Ansible Core Team
  * note: This module has a corresponding action plugin.

………………省略部分输出信息………………

EXAMPLES:

- name: Copy file with owner and permissions
  copy:
    src: /srv/myfiles/foo.conf
    dest: /etc/foo.conf
    owner: foo
    group: foo
    mode: &#39;0644&#39;

- name: Copy using inline content
  copy:
    content: &#39;# This file was moved to /etc/other.conf&#39;
    dest: /etc/mine.conf
</code></pre>
<p>在输出信息中列举了两种管理文件内容的示例。第一种用于文件的复制行为，第二种是通过<code>content</code>参数定</p>
<p>义内容，通过<code>dest</code>参数指定新建文件的名称。显然，第二种更加符合当前的实验场景。编写剧本文件如下</p>
<pre><code class="bash">[root@linuxprobe ~]# vim issue.yml
---
- name: 修改文件内容
  hosts: all
  tasks:
          - name: one
            copy:
                    content: &#39;Development&#39;
                    dest: /etc/issue
          - name: two
            copy:
                    content: &#39;Test&#39;
                    dest: /etc/issue
          - name: three
            copy:
                    content: &#39;Production&#39;
                    dest: /etc/issue
</code></pre>
<p>但是，如果按照这种顺序执行下去，每一台主机的<code>/etc/issue</code>文件都会被重复修改3次，最终定格</p>
<p>在“<code>Production</code>”字样，这显然缺少了一些东西。我们应该依据<code>inventory_hostname</code>变量中的值进行判断。</p>
<p>若主机为<code>dev</code>组，则执行第一个动作；若主机为<code>test</code>组，则执行第二个动作；若主机为<code>prod</code>组，则执行第</p>
<p>三个动作。因此，要进行3次判断。</p>
<blockquote>
<p> <code>when</code>是用于判断的语法，我们将其用在每个动作的下方进行判断，使得只有在满足条件才会执行</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# vim issue.yml
---
- name: 修改文件内容
  hosts: all
  tasks:
          - name: one
            copy:
                    content: &#39;Development&#39;
                    dest: /etc/issue
            when: &quot;inventory_hostname in groups.dev&quot;
          - name: two
            copy:
                    content: &#39;Test&#39;
                    dest: /etc/issue
            when: &quot;inventory_hostname in groups.test&quot;
          - name: three
            copy:
                    content: &#39;Production&#39;
                    dest: /etc/issue
            when: &quot;inventory_hostname in groups.prod&quot;
</code></pre>
<p>执行剧本文件，在过程中可清晰地看到由于<code>when</code>语法的作用，未在指定主机组中的主机将被跳过</p>
<p>（<code>skipping</code>）</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-playbook issue.yml 

PLAY [修改文件内容] ************************************************************************

TASK [Gathering Facts] ********************************************************************
ok: [192.168.10.20]
ok: [192.168.10.21]
ok: [192.168.10.22]
ok: [192.168.10.23]
ok: [192.168.10.24]

TASK [one] ********************************************************************************
changed: [192.168.10.20]
skipping: [192.168.10.21]
skipping: [192.168.10.22]
skipping: [192.168.10.23] 
skipping: [192.168.10.24]

TASK [two] ********************************************************************************
skipping: [192.168.10.20]
changed: [192.168.10.21]
skipping: [192.168.10.23]
skipping: [192.168.10.24]
skipping: [192.168.10.25]

TASK [three] ******************************************************************************
skipping: [192.168.10.20]
skipping: [192.168.10.21]
changed: [192.168.10.22]
changed: [192.168.10.23]
skipping: [192.168.10.24]

PLAY RECAP ********************************************************************************
192.168.10.20   : ok=2  changed=1  unreachable=0  failed=0  skipped=2  rescued=0  ignored=0   
192.168.10.21   : ok=2  changed=1  unreachable=0  failed=0  skipped=2  rescued=0  ignored=0   
192.168.10.22   : ok=2  changed=1  unreachable=0  failed=0  skipped=2  rescued=0  ignored=0   
192.168.10.23   : ok=2  changed=1  unreachable=0  failed=0  skipped=2  rescued=0  ignored=0 
192.168.10.24   : ok=1  changed=0  unreachable=0  failed=0  skipped=3  rescued=0  ignored=0 
</code></pre>
<p>登录到<code>dev</code>组的192.168.10.20主机上，查看文件内容</p>
<pre><code class="bash">[root@linuxprobe ~]# cat /etc/issue 
Development
</code></pre>
<p>登录到<code>test</code>组的192.168.10.21主机上，查看文件内容</p>
<pre><code class="bash">[root@linuxprobe ~]# cat /etc/issue 
Test
</code></pre>
<p>登录到<code>prod</code>组的192.168.10.22&#x2F;23主机上，查看文件内容</p>
<pre><code class="bash">[root@linuxprobe ~]# cat /etc/issue 
Production
</code></pre>
<h3 id="17-8、管理文件属性"><a href="#17-8、管理文件属性" class="headerlink" title="17.8、管理文件属性"></a>17.8、管理文件属性</h3><blockquote>
<p><code>Ansible</code>服务将常用的文件管理功能都合并到了<code>file</code>模块中，大家不用再为了寻找模块而“东奔西</p>
<p>跑”了。先来看一下<code>file</code>模块的帮助信息</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# ansible-doc file
&gt; FILE    (/usr/lib/python3.6/site-packages/ansible/modules/files/file.py)

        Set attributes of files, symlinks or directories.
        Alternatively, remove files, symlinks or directories. Many
        other modules support the same options as the `file&#39; module -
        including [copy], [template], and [assemble]. For Windows
        targets, use the [win_file] module instead.

  * This module is maintained by The Ansible Core Team

………………省略部分输出信息………………

EXAMPLES:

- name: Change file ownership, group and permissions
  file:
    path: /etc/foo.conf
    owner: foo
    group: foo
    mode: &#39;0644&#39;

- name: Create a symbolic link
  file:
    src: /file/to/link/to
    dest: /path/to/symlink
    owner: foo
    group: foo
    state: link

- name: Create a directory if it does not exist
  file:
    path: /etc/some_directory
    state: directory
    mode: &#39;0755&#39;

- name: Remove file (delete file)
  file:
    path: /etc/foo.txt
    state: absent
</code></pre>
<p>其中，<code>path</code>参数定义了文件的路径，<code>owner</code>参数定义了文件所有者，<code>group</code>参数定义了文件所属组，</p>
<p><code>mode</code>参数定义了文件权限，<code>src</code>参数定义了源文件的路径，<code>dest</code>参数定义了目标文件的路径，</p>
<p><code>state</code>参数则定义了文件类型。</p>
<blockquote>
<p>实验内容：</p>
<p>请创建出一个名为<code>/linuxprobe</code>的新目录，所有者及所属组均为<code>root</code>管理员身份；</p>
<p>设置所有者和所属于组拥有对文件的完全控制权，而其他人则只有阅读和执行权限；</p>
<p>给予<code>SGID</code>特殊权限；</p>
<p>仅在<code>dev</code>主机组的主机上实施。</p>
</blockquote>
<p>第二条要求是算术题，即将权限描述转换为数字表示法，即可读为4、可写为2、可执行为1。大家可以先自行</p>
<p>默默计算一下答案。此前在编写剧本文件时，<code>hosts</code>参数对应的一直是<code>all</code>，即全体主机，这次需要修改为</p>
<p>仅对<code>dev</code>主机组成员生效，请小心谨慎。编写模块代码如下</p>
<pre><code class="bash">[root@linuxprobe ~]# vim chmod.yml
---
- name: 管理文件属性
  hosts: dev
  tasks:
          - name: one
            file:
                    path: /linuxprobe
                    state: directory 
                    owner: root
                    group: root
                    mode: &#39;2775&#39;
</code></pre>
<p>临时添加一个需求：请再创建一个名称为<code>/linuxcool</code>的快捷方式文件，指向刚刚建立的<code>/linuxprobe</code>目</p>
<p>录。这样用户在访问两个目录时就能有相同的内容了。在使用<code>file</code>模块设置快捷方式时，不需要再单独创</p>
<p>建目标文件，<code>Ansible</code>服务会帮我们完成</p>
<pre><code class="bash">[root@linuxprobe ~]# vim chmod.yml
---
- name: 管理文件属性
  hosts: dev
  tasks:
          - name: one
            file:
                    path: /linuxprobe
                    state: directory 
                    owner: root
                    group: root
                    mode: &#39;2775&#39;
          - name: two
            file:
                    src: /linuxprobe
                    dest: /linuxcool
                    state: link
</code></pre>
<p>剧本文件的执行过程如下所示</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-playbook chmod.yml 

PLAY [管理文件属性] ***************************************************************

TASK [Gathering Facts] ***********************************************************
ok: [192.168.10.20]
ok: [192.168.10.21]
ok: [192.168.10.22]
ok: [192.168.10.23]
ok: [192.168.10.24]

TASK [one] ***********************************************************************
changed: [192.168.10.20]
skipping: [192.168.10.21]
skipping: [192.168.10.22]
skipping: [192.168.10.23]
skipping: [192.168.10.24]

TASK [two] ***********************************************************************
changed: [192.168.10.20]
skipping: [192.168.10.21]
skipping: [192.168.10.22]
skipping: [192.168.10.23]
skipping: [192.168.10.24]

PLAY RECAP ***********************************************************************
192.168.10.20   : ok=3  changed=2  unreachable=0  failed=0  skipped=0  rescued=0  ignored=0   
192.168.10.22   : ok=1  changed=0  unreachable=0  failed=0  skipped=3  rescued=0  ignored=0
192.168.10.22   : ok=1  changed=0  unreachable=0  failed=0  skipped=3  rescued=0  ignored=0
192.168.10.22   : ok=1  changed=0  unreachable=0  failed=0  skipped=3  rescued=0  ignored=0
192.168.10.22   : ok=1  changed=0  unreachable=0  failed=0  skipped=3  rescued=0  ignored=0
</code></pre>
<p>进入到<code>dev</code>组的主机中，可以看到<code>/linuxprobe</code>目录及<code>/linuxcool</code>的快捷方式均已经被顺利创建</p>
<pre><code class="bash">[root@linuxprobe ~]# ls -ld /linuxprobe
drwxrwsr-x. 2 root root 6 Apr 20 09:52 /linuxprobe
[root@linuxprobe ~]# ls -ld /linuxcool
lrwxrwxrwx. 1 root root 11 Apr 20 09:52 /linuxcool -&gt; /linuxprobe
</code></pre>
<h3 id="17-9、管理密码库文件"><a href="#17-9、管理密码库文件" class="headerlink" title="17.9、管理密码库文件"></a>17.9、管理密码库文件</h3><p>自<code>Ansible 1.5</code>版本发布后，<code>vault</code>作为一项新功能进入到了运维人员的视野。<strong>它不仅能对密码、剧本等敏</strong></p>
<p><strong>感信息进行加密，而且还可以加密变量名称和变量值，从而确保数据不会被他人轻易阅读</strong>。</p>
<p>使用<code>ansible-vault</code>命令可以实现内容的新建（<code>create</code>）、加密（<code>encrypt</code>）、解密</p>
<p>（<code>decrypt</code>）、修改密码（<code>rekey</code>）及查看（<code>view</code>）等功能</p>
<blockquote>
<p><strong>第1步</strong>：创建出一个名为<code>locker.yml</code>的配置文件，其中保存了两个变量值</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# vim locker.yml
---
pw_developer: Imadev
pw_manager: Imamgr
</code></pre>
<blockquote>
<p>第2步：使用<code>ansible-vault</code>命令对文件进行加密。由于需要每次输入密码比较麻烦，因此还应新建一</p>
<p>个用于保存密码值的文本文件，以便让<code>ansible-vault</code>命令自动调用。为了保证数据的安全性，在新建</p>
<p>密码文件后将该文件的权限设置为600，确保仅管理员可读可写</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# vim /root/secret.txt
whenyouwishuponastar
[root@linuxprobe ~]# chmod 600 /root/secret.txt
</code></pre>
<p>在<code>Ansible</code>服务的主配置文件中，在第140行的<code>vault_password_file</code>参数后指定密码值保存的文件路径，</p>
<p>准备进行调用</p>
<pre><code class="bash">[root@linuxprobe ~]# vim /etc/ansible/ansible.cfg
137 
138 # If set, configures the path to the Vault password file as an alternative to
139 # specifying --vault-password-file on the command line.
140 vault_password_file = /root/secret.txt
141 
</code></pre>
<blockquote>
<p><strong>第3步</strong>：在设置好密码文件的路径后，<code>Ansible</code>服务便会自动进行加载。用户也就不用在每次加密或解密</p>
<p>时都重复输入密码了。例如，在加密刚刚创建的<code>locker.yml</code>文件时，只需要使用<code>encrypt</code>参数即可</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# ansible-vault encrypt locker.yml
Encryption successful
</code></pre>
<p>件将使用<code>AES 256</code>加密方式进行加密，也就是意味着密钥有2256种可能。查看到加密后的内容为</p>
<pre><code class="bash">[root@linuxprobe ~]# cat locker.yml 
$ANSIBLE_VAULT;1.1;AES256
38653234313839336138383931663837333533396161343730353530313038313631653439366335
3432346333346239386334663836643432353434373733310a306662303565633762313232663763
38366334316239376262656230643531656665376166663635656436363338626464333430343162
6664643035316133650a333331393538616130656136653630303239663561663237373733373638
62383234303061623865633466336636363961623039343236356336356361613736333739623961
6334303865663838623363333339396637363061626363383266
</code></pre>
<p>如果不想使用原始密码了呢？也可以使用<code>rekey</code>参数手动对文件进行改密操作，</p>
<p>同时应结合<code>--ask-vault-pass</code>参数进行修改，否则<code>Ansible</code>服务会因接收不</p>
<p>到用户输入的旧密码值而拒绝新的密码变更请求</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-vault rekey --ask-vault-pass locker.yml 
Vault password: 输入旧的密码
New Vault password: 输入新的密码
Confirm New Vault password: 再输入新的密码
Rekey successful
</code></pre>
<blockquote>
<p><strong>第4步</strong>：如果想查看和修改加密文件中的内容，该怎么操作呢？对于已经加密过的文件，需要使用</p>
<p><code>ansible-vault</code>命令的<code>edit</code>参数进行修改，随后用<code>view</code>参数即可查看到修改后的内容。</p>
<p><code>ansible-vault</code>命令对加密文件的编辑操作默认使用的是Vim编辑器，在修改完毕后请记</p>
<p>得执行<code>wq</code>操作保存后退出</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# ansible-vault edit locker.yml
---
pw_developer: Imadev
pw_manager: Imamgr
pw_production: Imaprod
</code></pre>
<p>最后，再用<code>view</code>参数进行查看，便是最新的内容了</p>
<pre><code class="bash">[root@linuxprobe ~]# ansible-vault view locker.yml
Vault password: 输入密码后敲击回车确认
--- 
pw_developer: Imadev 
pw_manager: Imamgr 
pw_production: Imaprod
</code></pre>
<h2 id="十八、使用MariaDB数据库管理系统"><a href="#十八、使用MariaDB数据库管理系统" class="headerlink" title="十八、使用MariaDB数据库管理系统"></a>十八、使用MariaDB数据库管理系统</h2><hr>
<h3 id="18-1、初始化maridDB服务"><a href="#18-1、初始化maridDB服务" class="headerlink" title="18.1、初始化maridDB服务"></a>18.1、初始化<code>maridDB</code>服务</h3><blockquote>
<p>安装</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# yum install -y mariadb mariadb-server
</code></pre>
<blockquote>
<p>将其加入到开机启动项中</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# systemctl start  mariadb 
[root@linuxprobe ~]# systemctl enable mariadb 
Created symlink /etc/systemd/system/mysql.service → /usr/lib/systemd/system/mariadb.service.
Created symlink /etc/systemd/system/mysqld.service → /usr/lib/systemd/system/mariadb.service.
Created symlink /etc/systemd/system/multi-user.target.wants/mariadb.service → /usr/lib/systemd/system/mariadb.service.
</code></pre>
<blockquote>
<p>在确认<code>mariadb</code>数据库软件程序安装完毕并成功启动后请不要立即使用。为了确保数据库的安全性和正常运转，需要先对数据库程序进行初始化操作。这个初始化操作涉及下面5个步骤：</p>
<ul>
<li>设置<code>root</code>管理员在数据库中的密码值（注意，该密码并非<code>root</code>管理员在系统中的密码，这里的密码值默认应该为空，可直接按回车键）。</li>
<li>设置<code>root</code>管理员在数据库中的专有密码。</li>
<li>删除匿名用户，并使用<code>root</code>管理员从远程登录数据库，以确保数据库上运行的业务的安全性。</li>
<li>删除默认的测试数据库，取消测试数据库的一系列访问权限。</li>
<li>刷新授权列表，让初始化的设定立即生效。</li>
</ul>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# mysql_secure_installation 

NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB
      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!

In order to log into MariaDB to secure it, we&#39;ll need the current
password for the root user.  If you&#39;ve just installed MariaDB, and
you haven&#39;t set the root password yet, the password will be blank,
so you should just press enter here.

Enter current password for root (enter for none): 输入管理员原始密码，默认为空值，直接回车即可
OK, successfully used password, moving on...

Setting the root password ensures that nobody can log into the MariaDB
root user without the proper authorisation.

Set root password? [Y/n] y（设置管理员密码）
New password: 输入新的密码
Re-enter new password: 再次输入密码
Password updated successfully!
Reloading privilege tables..
 ... Success!


By default, a MariaDB installation has an anonymous user, allowing anyone
to log into MariaDB without having to have a user account created for
them.  This is intended only for testing, and to make the installation
go a bit smoother.  You should remove them before moving into a
production environment.

Remove anonymous users? [Y/n] y（删除匿名账户）
 ... Success!

Normally, root should only be allowed to connect from &#39;localhost&#39;.  This
ensures that someone cannot guess at the root password from the network.

Disallow root login remotely? [Y/n] y（禁止管理员从远程登录）
 ... Success!

By default, MariaDB comes with a database named &#39;test&#39; that anyone can
access.  This is also intended only for testing, and should be removed
before moving into a production environment.

Remove test database and access to it? [Y/n] y（删除测试数据库及其访问权限）
 - Dropping test database...
 ... Success!
 - Removing privileges on test database...
 ... Success!

Reloading the privilege tables will ensure that all changes made so far
will take effect immediately.

Reload privilege tables now? [Y/n] y（刷新授权表，让初始化后的设定立即生效）
 ... Success!

Cleaning up...

All done!  If you&#39;ve completed all of the above steps, your MariaDB
installation should now be secure.

Thanks for using MariaDB!
</code></pre>
<p>在很多生产环境中都需要使用站库分离的技术（即网站和数据库不在同一个服务器上），如果需要让<code>root</code>管</p>
<p>理员远程访问数据库，可在上面的初始化操作中设置策略，以允许<code>root</code>管理员从远程访问。然后还需要设置</p>
<p>防火墙，使其放行对数据库服务程序的访问请求。数据库服务程序默认会占用3306端口，在防火墙策略中服</p>
<p>务名称统一叫作<code>mysql</code></p>
<pre><code class="bash">[root@linuxprobe ~]# firewall-cmd --permanent --add-service=mysql
success
[root@linuxprobe ~]# firewall-cmd --reload
success
</code></pre>
<p>一切准备就绪。现在我们将首次登录<code>MariaDB</code>数据库。管理数据库的命令为<code>mysql</code>，其中，<code>-u</code>参数用来指定</p>
<p>以<code>root</code>管理员的身份登录，而<code>-p</code>参数用来验证该用户在数据库中的密码值。</p>
<pre><code class="bash">[root@linuxprobe ~]# mysql -u root -p
Enter password: 输入刚才设置的管理员密码后敲击回车
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 16
Server version: 10.3.11-MariaDB MariaDB Server

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.
</code></pre>
<p>初次使用数据库管理工具的读者，可以输入<code>help</code>命令查看<code>mariadb</code>服务能做的操作，语句的用法与<code>MySQL</code></p>
<p>一模一样</p>
<pre><code class="bash">MariaDB [(none)]&gt; help

General information about MariaDB can be found at http://mariadb.org

List of all MySQL commands:
Note that all text commands must be first on line and end with &#39;;&#39;
?         (\?) Synonym for `help&#39;.
clear     (\c) Clear the current input statement.
connect   (\r) Reconnect to the server. Optional arguments are db and host.
delimiter (\d) Set statement delimiter.
edit      (\e) Edit command with $EDITOR.
ego       (\G) Send command to mysql server, display result vertically.
exit      (\q) Exit mysql. Same as quit.
go        (\g) Send command to mysql server.
help      (\h) Display this help.
nopager   (\n) Disable pager, print to stdout.
notee     (\t) Don&#39;t write into outfile.
pager     (\P) Set PAGER [to_pager]. Print the query results via PAGER.
print     (\p) Print current command.
prompt    (\R) Change your mysql prompt.
quit      (\q) Quit mysql.
rehash    (\#) Rebuild completion hash.
source    (\.) Execute an SQL script file. Takes a file name as an argument.
status    (\s) Get status information from the server.
system    (\!) Execute a system shell command.
tee       (\T) Set outfile [to_outfile]. Append everything into given outfile.
use       (\u) Use another database. Takes database name as argument.
charset   (\C) Switch to another charset. Might be needed for processing binlog with multi-byte charsets.
warnings  (\W) Show warnings after every statement.
nowarning (\w) Don&#39;t show warnings after every statement.

For server side help, type &#39;help contents&#39;
</code></pre>
<blockquote>
<p>查看数据库管理系统中当前都有哪些数据库</p>
</blockquote>
<pre><code class="ash">bMariaDB [(none)]&gt; SHOW databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
+--------------------+
3 rows in set (0.000 sec)
</code></pre>
<p>使用数据库命令将<code>root</code>管理员在数据库管理系统中的密码值修改为<code>linuxprobe</code>。这样退出后再尝试登录，</p>
<p>如果还坚持输入原先的密码，则将提示访问失败</p>
<pre><code class="bash">MariaDB [(none)]&gt; SET password = PASSWORD(&#39;linuxprobe&#39;);
Query OK, 0 rows affected (0.001 sec)

MariaDB [(none)]&gt; exit
Bye
[root@linuxprobe ~]# mysql -u root -p
Enter password: 此处输入管理员在数据库中的旧密码
ERROR 1045 (28000): Access denied for user &#39;root&#39;@&#39;localhost&#39; (using password: YES)
</code></pre>
<p>输入新密码（linuxprobe）后，便可顺利进入数据库管理工具中</p>
<pre><code class="bash">[root@linuxprobe ~]# mysql -u root -p
Enter password: 此处输入管理员在数据库中的新密码
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 20
Server version: 10.3.11-MariaDB MariaDB Server

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.
</code></pre>
<h3 id="18-2、管理用户以及授权"><a href="#18-2、管理用户以及授权" class="headerlink" title="18.2、管理用户以及授权"></a>18.2、管理用户以及授权</h3><blockquote>
<p>按照“CREATE USER用户名@主机名IDENTIFIED BY ‘密码’;”的格式创建数据库管理用户</p>
</blockquote>
<pre><code class="mysql">MariaDB [(none)]&gt; CREATE USER luke@localhost IDENTIFIED BY &#39;linuxprobe&#39;;
Query OK, 0 rows affected (0.00 sec)
</code></pre>
<blockquote>
<p>创建的用户信息可以使用SELECT命令语句来查询。下面命令查询的是用户luke的主机名称、用户名称以</p>
<p>及经过加密的密码值信息</p>
</blockquote>
<pre><code class="mysql">MariaDB [(none)]&gt; use mysql;
Database changed
MariaDB [mysql]&gt; SELECT HOST,USER,PASSWORD FROM user WHERE USER=&quot;luke&quot;;
+-----------+------+-------------------------------------------+
| HOST      | USER | PASSWORD                                  |
+-----------+------+-------------------------------------------+
| localhost | luke | *55D9962586BE75F4B7D421E6655973DB07D6869F |
+-----------+------+-------------------------------------------+
1 row in set (0.001 sec)
</code></pre>
<blockquote>
<p>不过，用户<code>luke</code>仅仅是一位普通用户，没有数据库的任何操作权限。不信的话，可以切换到<code>luke</code>用户</p>
<p>来查询数据库管理系统中当前都有哪些数据库。可以发现，该用户甚至没法查看完整的数据库列表（刚</p>
<p>才使用<code>root</code>用户时可以查看到3个数据库列表）</p>
</blockquote>
<pre><code class="mysql">MariaDB [mysql]&gt; exit
Bye
[root@linuxprobe ~]# mysql -u luke -p
Enter password: 输入luke用户的数据库密码
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 21
Server version: 10.3.11-MariaDB MariaDB Server

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.

MariaDB [(none)]&gt; SHOW databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
+--------------------+
1 row in set (0.001 sec)
</code></pre>
<blockquote>
<p>GRANT命令的常见格式以及解释</p>
</blockquote>
<table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>GRANT 权限 ON 数据库.表单名称 TO 用户名@主机名</td>
<td>对某个特定数据库中的特定表单给予授权</td>
</tr>
<tr>
<td>GRANT 权限 ON 数据库.* TO 用户名@主机名</td>
<td>对某个特定数据库中的所有表单给予授权</td>
</tr>
<tr>
<td>GRANT 权限 ON <em>.</em> TO 用户名@主机名</td>
<td>对所有数据库及所有表单给予授权</td>
</tr>
<tr>
<td>GRANT 权限1,权限2 ON 数据库.* TO 用户名@主机名</td>
<td>对某个数据库中的所有表单给予多个授权</td>
</tr>
<tr>
<td>GRANT ALL PRIVILEGES ON <em>.</em> TO 用户名@主机名</td>
<td>对所有数据库及所有表单给予全部授权（需谨慎操作）</td>
</tr>
</tbody></table>
<blockquote>
<p>针对<code>mysql</code>数据库中的<code>user</code>表单向用户<code>luke</code>授予<strong>查询、更新、删除</strong>以及<strong>插入</strong>等权限</p>
</blockquote>
<pre><code class="mysql">[root@linuxprobe ~]# mysql -u root -p
Enter password: 输入管理员的数据库密码
MariaDB [(none)]&gt; use mysql;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A
Database changed
MariaDB [mysql]&gt; GRANT SELECT,UPDATE,DELETE,INSERT ON mysql.user TO luke@localhost;
Query OK, 0 rows affected (0.001 sec)
</code></pre>
<blockquote>
<p>查看一下用户<code>luke</code>的权限</p>
</blockquote>
<pre><code class="mysql">MariaDB [(none)]&gt;  SHOW GRANTS FOR luke@localhost;
+---------------------------------------------------------------------------------------------+
| Grants for luke@localhost                                                                   |
+---------------------------------------------------------------------------------------------+
| GRANT USAGE ON *.* TO &#39;luke&#39;@&#39;localhost&#39; IDENTIFIED BY PASSWORD &#39;*55D9962586BE75F4B7D421E6655973DB07D6869F&#39; |
| GRANT SELECT, INSERT, UPDATE, DELETE ON `mysql`.`user` TO &#39;luke&#39;@&#39;localhost&#39;                |
+---------------------------------------------------------------------------------------------+
2 rows in set (0.000 sec)
</code></pre>
<blockquote>
<p>上面输出信息中显示用户<code>luke</code>已经拥有了针对<code>mysql</code>数据库中<code>user</code>表单的一系列权限了。这时我们再</p>
<p>切换到用户<code>luke</code>，此时就能够看到<code>mysql</code>数据库了，而且还能看到表单<code>user</code>（其余表单会因无权限而</p>
<p>被继续隐藏）</p>
</blockquote>
<pre><code class="mysql">[root@linuxprobe ~]# mysql -u luke -p
Enter password: 输入luke用户的数据库密码

MariaDB [(none)]&gt; SHOW databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
+--------------------+
2 rows in set (0.000 sec)

MariaDB [(none)]&gt; use mysql;
Database changed

MariaDB [mysql]&gt; SHOW tables;
+-----------------+
| Tables_in_mysql |
+-----------------+
| user            |
+-----------------+
1 row in set (0.001 sec)

MariaDB [mysql]&gt; exit
Byes
</code></pre>
<blockquote>
<p>切换回root管理员用户，移除刚才的授权</p>
</blockquote>
<pre><code class="mysql">[root@linuxprobe ~]# mysql -u root -p
Enter password: 输入管理员的数据库密码
MariaDB [(none)]&gt; use mysql;
Database changed
MariaDB [(none)]&gt; REVOKE SELECT,UPDATE,DELETE,INSERT ON mysql.user FROM luke@localhost;
Query OK, 0 rows affected (0.00 sec)
</code></pre>
<blockquote>
<p>执行移除授权命令后，再来查看用户luke的信息</p>
</blockquote>
<pre><code class="mysql">MariaDB [(none)]&gt; SHOW GRANTS FOR luke@localhost;
+---------------------------------------------------------------------------------------------+
| Grants for luke@localhost                                                                   |
+---------------------------------------------------------------------------------------------+
| GRANT USAGE ON *.* TO &#39;luke&#39;@&#39;localhost&#39; IDENTIFIED BY PASSWORD &#39;*55D9962586BE75F4B7D421E6655973DB07D6869F&#39; |
+---------------------------------------------------------------------------------------------+
1 row in set (0.001 sec)
</code></pre>
<blockquote>
<p>DROP命令删除用户</p>
</blockquote>
<pre><code class="mysql">MariaDB [(none)]&gt; DROP user luke@localhost;
Query OK, 0 rows affected (0.000 sec)
</code></pre>
<h3 id="18-3、创建数据库与表单"><a href="#18-3、创建数据库与表单" class="headerlink" title="18.3、创建数据库与表单"></a>18.3、创建数据库与表单</h3><blockquote>
<p>用于创建数据库的命令以及作用</p>
</blockquote>
<table>
<thead>
<tr>
<th>命令用法</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>CREATE database 数据库名称。</td>
<td>创建新的数据库</td>
</tr>
<tr>
<td>DESCRIBE 表单名称;</td>
<td>描述表单</td>
</tr>
<tr>
<td>UPDATE 表单名称 SET attribute&#x3D;新值 WHERE attribute &gt; 原始值;</td>
<td>更新表单中的数据</td>
</tr>
<tr>
<td>USE 数据库名称;</td>
<td>指定使用的数据库</td>
</tr>
<tr>
<td>SHOW databases;</td>
<td>显示当前已有的数据库</td>
</tr>
<tr>
<td>SHOW tables;</td>
<td>显示当前数据库中的表单</td>
</tr>
<tr>
<td>SELECT * FROM 表单名称;</td>
<td>从表单中选中某个记录值</td>
</tr>
<tr>
<td>DELETE FROM 表单名 WHERE attribute&#x3D;值;</td>
<td>从表单中删除某个记录值</td>
</tr>
</tbody></table>
<blockquote>
<p>创建一个名为<code>linuxprobe</code>的数据库，然后再查看数据库列表</p>
</blockquote>
<pre><code class="mysql">MariaDB [(none)]&gt;  CREATE DATABASE linuxprobe;
Query OK, 1 row affected (0.001 sec)

MariaDB [(none)]&gt;  SHOW databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| linuxprobe         |
| mysql              |
| performance_schema |
+--------------------+
4 rows in set (0.001 sec)
</code></pre>
<blockquote>
<p>定义3个字段项，其中，字符型字段name（长度为15字符）用来存放图书名称，整型字段price和pages</p>
<p>分别存储图书的价格和页数。当执行完下述命令之后，就可以看到表单的结构信息了</p>
</blockquote>
<pre><code class="mysql">MariaDB [(none)]&gt; use linuxprobe;
Database changed
MariaDB [linuxprobe]&gt; CREATE TABLE mybook (name char(15),price int,pages int);
Query OK, 0 rows affected (0.009 sec)

MariaDB [linuxprobe]&gt; DESCRIBE mybook;
+-------+----------+------+-----+---------+-------+
| Field | Type     | Null | Key | Default | Extra |
+-------+----------+------+-----+---------+-------+
| name  | char(15) | YES  |     | NULL    |       |
| price | int(11)  | YES  |     | NULL    |       |
| pages | int(11)  | YES  |     | NULL    |       |
+-------+----------+------+-----+---------+-------+
3 rows in set (0.002 sec)
</code></pre>
<h3 id="18-4、管理表单以及数据"><a href="#18-4、管理表单以及数据" class="headerlink" title="18.4、管理表单以及数据"></a>18.4、管理表单以及数据</h3><blockquote>
<p>插入数据</p>
</blockquote>
<pre><code class="mysql">MariaDB [linuxprobe]&gt; INSERT INTO mybook(name,price,pages) VALUES(&#39;linuxprobe&#39;,&#39;60&#39;, &#39;518&#39;);
Query OK, 1 row affected (0.001 sec)

MariaDB [linuxprobe]&gt; SELECT * from mybook;
+------------+-------+-------+
| name       | price | pages |
+------------+-------+-------+
| linuxprobe |    60 |   518 |
+------------+-------+-------+
1 row in set (0.000 sec)
</code></pre>
<blockquote>
<p>更新数据</p>
</blockquote>
<pre><code class="mysql">MariaDB [linuxprobe]&gt; UPDATE mybook SET price=55 ;
Query OK, 1 row affected (0.002 sec)
Rows matched: 1  Changed: 1  Warnings: 0

MariaDB [linuxprobe]&gt; SELECT name,price FROM mybook;
+------------+-------+
| name       | price |
+------------+-------+
| linuxprobe |    55 |
+------------+-------+
1 row in set (0.000 sec)
</code></pre>
<blockquote>
<p>按照条件修改数据</p>
</blockquote>
<pre><code class="mysql">MariaDB [linuxprobe]&gt; UPDATE mybook SET price=60 where name=&#39;linuxcool&#39;;
Query OK, 1 row affected (0.001 sec)
Rows matched: 1  Changed: 1  Warnings: 0

MariaDB [linuxprobe]&gt; select * from mybook;
+------------+-------+-------+
| name       | price | pages |
+------------+-------+-------+
| linuxprobe |    55 |   518 |
| linuxcool  |    60 |   300 |
| linuxdown  |   105 |   500 |
+------------+-------+-------+
3 rows in set (0.001 sec)
</code></pre>
<blockquote>
<p>删除数据</p>
</blockquote>
<pre><code class="mysql">MariaDB [linuxprobe]&gt; DELETE FROM mybook;
Query OK, 3 row affected (0.001 sec)

MariaDB [linuxprobe]&gt; SELECT * FROM mybook;
Empty set (0.000 sec)
</code></pre>
<blockquote>
<p>where命令中使用的参数以及作用</p>
</blockquote>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>&#x3D;</td>
<td>相等</td>
</tr>
<tr>
<td>&lt;&gt;或!&#x3D;</td>
<td>不相等</td>
</tr>
<tr>
<td>&gt;</td>
<td>大于</td>
</tr>
<tr>
<td>&lt;</td>
<td>小于</td>
</tr>
<tr>
<td>&gt;&#x3D;</td>
<td>大于或等于</td>
</tr>
<tr>
<td>&lt;&#x3D;</td>
<td>小于或等于</td>
</tr>
<tr>
<td>BETWEEN</td>
<td>在某个范围内</td>
</tr>
<tr>
<td>LIKE</td>
<td>搜索一个例子</td>
</tr>
<tr>
<td>IN</td>
<td>在列中搜索多个值</td>
</tr>
</tbody></table>
<pre><code class="mysql">MariaDB [linuxprobe]&gt; SELECT * FROM mybook WHERE price&gt;75;
+-------------+-------+-------+
| name        | price | pages |
+-------------+-------+-------+
| linuxprobe3 |    80 |   518 |
| linuxprobe4 |   100 |   518 |
+-------------+-------+-------+
2 rows in set (0.001 sec)

MariaDB [linuxprobe]&gt; SELECT * FROM mybook WHERE price!=80;
+-------------+-------+-------+
| name        | price | pages |
+-------------+-------+-------+
| linuxprobe1 |    30 |   518 |
| linuxprobe2 |    50 |   518 |
| linuxprobe4 |   100 |   518 |
+-------------+-------+-------+
3 rows in set (0.000 sec)
</code></pre>
<pre><code class="mysql">MariaDB [linuxprobe]&gt; SELECT * from mybook WHERE price=30 AND pages=518 ;
+-------------+-------+-------+
| name        | price | pages |
+-------------+-------+-------+
| linuxprobe1 |    30 |   518 |
+-------------+-------+-------+
1 row in set (0.000 sec)
</code></pre>
<h3 id="18-5、数据库的备份与恢复"><a href="#18-5、数据库的备份与恢复" class="headerlink" title="18.5、数据库的备份与恢复"></a>18.5、数据库的备份与恢复</h3><blockquote>
<p>将linuxprobe数据库中的内容导出为一个文件，并保存到root管理员的家目录中</p>
</blockquote>
<pre><code class="mysql">[root@linuxprobe ~]# mysqldump -u root -p linuxprobe &gt; /root/linuxprobeDB.dump
Enter password: 输入管理员的数据库密码
</code></pre>
<blockquote>
<p>然后进入MariaDB数据库管理系统，彻底删除linuxprobe数据库，这样mybook数据表单也将被彻底删</p>
<p>除。然后重新建立linuxprobe数据库</p>
</blockquote>
<pre><code class="mysql">mysq[root@linuxprobe ~]# mysql -u root -p
Enter password: 输入管理员的数据库密码

MariaDB [(none)]&gt; DROP DATABASE linuxprobe;
Query OK, 1 row affected (0.04 sec)

MariaDB [(none)]&gt; SHOW databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
+--------------------+
3 rows in set (0.02 sec)

MariaDB [(none)]&gt; CREATE DATABASE linuxprobe;
Query OK, 1 row affected (0.00 sec)
</code></pre>
<blockquote>
<p>接下来是见证数据恢复效果的时刻！使用输入重定向符把刚刚备份的数据库文件导入到mysql命令中，然</p>
<p>后执行该命令。接下来登录MariaDB数据库，就又能看到linuxprobe数据库以及mybook数据表单了。数</p>
<p>据库恢复成功！</p>
</blockquote>
<pre><code class="mysql">[root@linuxprobe ~]# mysql -u root -p linuxprobe &lt; /root/linuxprobeDB.dump 
Enter password: 输入管理员的数据库密码
[root@linuxprobe ~]# mysql -u root -p
Enter password: 输入管理员的数据库密码
MariaDB [(none)]&gt; use linuxprobe;
Database changed

MariaDB [linuxprobe]&gt; SHOW tables;
+----------------------+
| Tables_in_linuxprobe |
+----------------------+
| mybook               |
+----------------------+
1 row in set (0.000 sec)

MariaDB [linuxprobe]&gt; describe mybook;
+-------+----------+------+-----+---------+-------+
| Field | Type     | Null | Key | Default | Extra |
+-------+----------+------+-----+---------+-------+
| name  | char(15) | YES  |     | NULL    |       |
| price | int(11)  | YES  |     | NULL    |       |
| pages | int(11)  | YES  |     | NULL    |       |
+-------+----------+------+-----+---------+-------+
3 rows in set (0.002 sec)
</code></pre>
<h3 id="18-6、配置Mysql服务"><a href="#18-6、配置Mysql服务" class="headerlink" title="18.6、配置Mysql服务"></a>18.6、配置<code>Mysql</code>服务</h3><blockquote>
<p>对于<code>MySQL</code>数据库来说，我们需要在系统中创建一个名为<code>mysql</code>的用户，专门用于负责运行<code>MySQL</code>数据</p>
<p>库。请记得要把这类账户的<code>Bash</code>终端设置成<code>nologin</code>解释器，避免黑客通过该用户登录到服务器中，从</p>
<p>而提高系统安全性。</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe lnmp]# useradd mysql -M -s /sbin/nologin
</code></pre>
<blockquote>
<p><strong>第1步</strong>：解压<code>MySQL</code>安装软件包。将解压出的程序目录改名并移动到<code>/usr/local</code>目录下，对其进行初始</p>
<p>化操作后便可使用。需要注意的是，以.tar.xz结尾的压缩包软件，不应用z参数进行解压。</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe lnmp]# tar xvf mysql-8.0.18.tar.xz
[root@linuxprobe lnmp]# mv mysql-8.0.18-linux-glibc2.12-x86_64 mysql
[root@linuxprobe lnmp]# mv mysql /usr/local
</code></pre>
<blockquote>
<p><strong>第2步</strong>：在生产环境中管理<code>MySQL</code>数据库时，有两个比较常用的目录。一个是<code>/usr/local/mysql</code>目录，</p>
<p>这是用于保存MySQL数据库程序文件的路径。还有一个是<code>/usr/local/mysql/data</code>目录，它用于存</p>
<p>储数据库的具体内容，每个数据库的内容会被单独存放到一个目录内。对于存放实际数据库文件的<code>data</code></p>
<p>目录，用户需要先手动创建出来</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe lnmp]# cd /usr/local/mysql
[root@linuxprobe mysql]# mkdir data
</code></pre>
<blockquote>
<p><strong>第3步</strong>：初始化<code>MySQL</code>服务程序，对目录进行授权，保证数据能够被<code>mysql</code>系统用户读取。在初始化阶</p>
<p>段，应使用<code>mysqld</code>命令确认管理<code>MySQL</code>数据库服务的用户名称、数据保存目录及编码信息。在信息确认</p>
<p>无误后开始进行初始化。在初始化的最后阶段，系统会给用户分配一个初始化的临时密码，大家一定要</p>
<p>保存好，例如下面示例中分配的密码是qfroRs,Ei4Ls。</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe mysql]# chown -R mysql:mysql /usr/local/mysql
[root@linuxprobe mysql]# cd bin
[root@linuxprobe bin]# ./mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data
2021-05-06T07:07:06.243270Z 0 [System] [MY-013169] [Server] /usr/local/mysql/bin/mysqld (mysqld 8.0.18) initializing of server in progress as process 7606
2021-05-06T07:07:08.116268Z 5 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: qfroRs,Ei4Ls
</code></pre>
<blockquote>
<p><strong>第4步</strong>：与<code>Nginx</code>服务相似，<code>MySQL</code>数据库的二进制可执行命令也单独存放在自身的程序目</p>
<p>录<code>/usr/local/mysql/bin</code>中。若每次在执行命令之前都要先切换到这个目录，则着实有些</p>
<p>麻烦，要能也加入到<code>PATH</code>变量中可就方便太多了。说干就干！</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe bin]# vim ~/.bash_profile
# .bash_profile

# Get the aliases and functions
if [ -f ~/.bashrc ]; then
        . ~/.bashrc
fi

# User specific environment and startup programs

PATH=$PATH:$HOME/bin:/usr/local/nginx/sbin:/usr/local/mysql/bin

export PATH
[root@linuxprobe bin]# source ~/.bash_profile
</code></pre>
<blockquote>
<p>将启动脚本<code>mysql.server</code>放入到<code>/etc/init.d</code>目录中，让服务器每次重启后都能自动启动数据库，并</p>
<p>给予可执行权限。</p>
<p><code>libtinfo.so.5</code>文件是<code>MySQL</code>数据库在8.0版本后新添加的重要的函数库文件，但默认不存在，需要将</p>
<p><code>libtinfo.so.6.1</code>文件复制过来或者作为链接文件才能正常启动</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe bin]# cd /usr/local/mysql
[root@linuxprobe mysql]# cp -a support-files/mysql.server /etc/init.d/
[root@linuxprobe mysql]# chmod a+x /etc/init.d/mysql.server
[root@linuxprobe mysql]# ln -s /usr/lib64/libtinfo.so.6.1 /usr/lib64/libtinfo.so.5 
</code></pre>
<blockquote>
<p><strong>第5步</strong>：执行<code>MySQL</code>数据库服务启动文件，并进行初始化工作。为了安全着想，MySQL自8.0版本起不再</p>
<p>允许用户使用临时密码来管理数据库内容，也不能进行远程控制，用户必须修改初始化密码后才能使用</p>
<p><code>MySQL</code>数据库。数据库作为系统重要的组成服务，密码位数不建议少于20位。例如，下面将密码修改</p>
<p>为“PObejCBeDzTRCncXwgBy”</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe mysql]# /etc/init.d/mysql.server start 
Starting MySQL.Logging to &#39;/usr/local/mysql/data/linuxprobe.com.err&#39;.
. SUCCESS! 
[root@linuxprobe mysql]# mysql -u root -p
Enter password: 输入初始化时给的原始密码
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 8
Server version: 8.0.18

Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.

mysql&gt; alter user &#39;root&#39;@&#39;localhost&#39; identified by &#39;PObejCBeDzTRCncXwgBy&#39;; 
Query OK, 0 rows affected (0.01 sec)

mysql&gt; 
</code></pre>
<blockquote>
<p>但这样还是不行，还需要继续切换到<code>mysql</code>数据库中，修改<code>user</code>表单的密码值。这也是从<code>MySQL</code>数据库</p>
<p>8.0版本之后才有的新安全要求，看过本书上一版的读者应该记得在MySQL 5&#x2F;6版本中就没有这么麻烦</p>
</blockquote>
<pre><code class="bash">mysql&gt; use mysql;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql&gt; show tables;
+---------------------------+
| Tables_in_mysql           |
+---------------------------+
| columns_priv              |
| tables_priv               |
| time_zone                 |
| time_zone_leap_second     |
| time_zone_name            |
| time_zone_transition      |
| time_zone_transition_type |
| user                      |
| …………省略部分输出信息…………  |
+---------------------------+
33 rows in set (0.00 sec)

mysql&gt; ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED WITH mysql_native_password BY &#39;PObejCBeDzTRCncXwgBy&#39;;
Query OK, 0 rows affected (0.01 sec)
</code></pre>
<h2 id="十九、使用PXE-Kickstart无人值守安装服务"><a href="#十九、使用PXE-Kickstart无人值守安装服务" class="headerlink" title="十九、使用PXE+Kickstart无人值守安装服务"></a>十九、使用PXE+Kickstart无人值守安装服务</h2><hr>
<h3 id="19-1、无人值守系统"><a href="#19-1、无人值守系统" class="headerlink" title="19.1、无人值守系统"></a>19.1、无人值守系统</h3><blockquote>
<p>如果生产环境中有数百台服务器都需要安装系统，这种方式就不合时宜了。这时，就需要使用</p>
<p><code>PXE</code> +<code> TFTP</code> + <code>FTP</code> + <code>DHCP</code> + <code>Kickstart</code>服务搭建出一个无人值守安装系统。这种无人值守安</p>
<p>装系统可以自动地为数十台甚至上百台的服务器安装系统，这一方面将运维人员从重复性的工作</p>
<p>中解救出来，另外一方面也大大提升了系统安装的效率。无人值守安装系统的工作流程如图19-1所示。</p>
</blockquote>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825170208752.png" alt="图19-1 无人值守安装系统的工作流程"></p>
<blockquote>
<p><code>PXE</code>（<code>Preboot eXecute Environment</code>，预启动执行环境）是由<code>Intel</code>公司开发的技术，能够让计算</p>
<p>机通过网络来启动操作系统（前提是计算机上安装的网卡支持<code>PXE</code>技术），主要用于在无人值守安装系</p>
<p>统中引导客户端主机安装<code>Linux</code>操作系统。</p>
<p><code>Kickstart</code>是一种无人值守的安装方式，其工作原理是预先把原本需要运维人员手工填写的参数保存成</p>
<p>一个<code>ks.cfg</code>文件，当安装过程中需要填写参数时则自动匹配<code>Kickstart</code>生成的文件。所以只要</p>
<p><code>Kickstart</code>文件包含了安装过程中需要人工填写的所有参数，那么从理论上来讲完全不需要运维人员的</p>
<p>干预，就可以自动完成安装工作。</p>
</blockquote>
<h3 id="19-2、部署相关服务程序"><a href="#19-2、部署相关服务程序" class="headerlink" title="19.2、部署相关服务程序"></a>19.2、部署相关服务程序</h3><table>
<thead>
<tr>
<th>服务名称</th>
<th>主要作用</th>
</tr>
</thead>
<tbody><tr>
<td>dhcpd</td>
<td>分配网卡信息及指引获取驱动文件</td>
</tr>
<tr>
<td>tftp-server</td>
<td>提供驱动及引导文件的传输</td>
</tr>
<tr>
<td>SYSLinux</td>
<td>提供驱动及引导文件</td>
</tr>
<tr>
<td>VSFtpd</td>
<td>提供完整系统镜像的传输</td>
</tr>
<tr>
<td>KickStart</td>
<td>提供安装过程中选项的问答设置</td>
</tr>
</tbody></table>
<h4 id="19-2-1、配置DHCP服务"><a href="#19-2-1、配置DHCP服务" class="headerlink" title="19.2.1、配置DHCP	服务"></a>19.2.1、配置<code>DHCP</code>	服务</h4><blockquote>
<p><code>DHCP</code>服务程序用于为客户端主机分配可用的<code>IP</code>地址，而且这是服务器与客户端主机进行文件传输的基</p>
<p>础，因此要先行配置<code>DHCP</code>服务程序。首先按照表为无人值守系统设置<code>IP</code>地址，然后按照图19-2和</p>
<p>图19-3在虚拟机的虚拟网络编辑器中关闭自身的<code>DHCP</code>服务，避免与自己配置的服务冲突。</p>
</blockquote>
<blockquote>
<p> 无人值守系统与客户端的设置</p>
</blockquote>
<table>
<thead>
<tr>
<th>主机名称</th>
<th>操作系统</th>
<th>IP地址</th>
</tr>
</thead>
<tbody><tr>
<td>无人值守系统</td>
<td>RHEL 8</td>
<td>192.168.10.10</td>
</tr>
<tr>
<td>客户端</td>
<td>未安装操作系统</td>
<td>-</td>
</tr>
</tbody></table>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825170608170.png" alt="图19-3 关闭虚拟机自带的DHCP服务"></p>
<blockquote>
<p>除了上面提及的服务之外，<code>PXE </code>+ <code>KickStart</code>无人值守安装系统还会用到诸如<code>sips</code>、<code>slp</code>、<code>mountd</code>等</p>
<p>多项相关的服务协议，因此本实验会临时关闭<code>firewalld</code>防火墙，以便数据能够正常地传送</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe pub]# iptables -F
[root@linuxprobe pub]# systemctl stop firewalld
</code></pre>
<blockquote>
<p>当挂载好光盘镜像并把仓库文件配置妥当后，就可以安装<code>DHCP</code>服务程序软件包了</p>
</blockquote>
<pre><code>[root@linuxprobe ~]# yum install -y dhcp-server
</code></pre>
<blockquote>
<p>允许<code>BOOTP</code>引导程序协议，旨在让局域网内暂时没有操作系统的主机也能获取静态IP地址；在配置文件</p>
<p>的最下面加载了引导驱动文件<code>pxelinux.0</code>（这个文件会在下面的步骤中创建），其目的是让客户端主机</p>
<p>获取到IP地址后主动获取引导驱动文件，自行进入下一步的安装过程。</p>
<p><strong>当前<code>pxelinux.0</code>文件不存在，不过不用担心，后面会找到它的。</strong></p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# vim /etc/dhcp/dhcpd.conf
allow booting;
allow bootp;
ddns-update-style none;
ignore client-updates;
subnet 192.168.10.0 netmask 255.255.255.0 &#123;
        option subnet-mask                 255.255.255.0;
        option domain-name-servers         192.168.10.10;
        range dynamic-bootp 192.168.10.100 192.168.10.200;
        default-lease-time                 21600;
        max-lease-time                     43200;
        next-server                        192.168.10.10;
        filename                           &quot;pxelinux.0&quot;;
&#125;
</code></pre>
<blockquote>
<p>启动<code>dhcpd后</code>查看一下服务状态，以免后续实验中客户端分配不到网卡信息。若输出状态为</p>
<p>“**active (running)**”则表示服务已经正常运行</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# systemctl status dhcpd
● dhcpd.service - DHCPv4 Server Daemon
   Loaded: loaded (/usr/lib/systemd/system/dhcpd.service; enabled; vendor preset: disabled)
   Active: active (running) since Fri 2021-04-30 01:10:51 CST; 3min 15s ago
     Docs: man:dhcpd(8)
           man:dhcpd.conf(5)
 Main PID: 30964 (dhcpd)
   Status: &quot;Dispatching packets...&quot;
    Tasks: 1 (limit: 12390)
   Memory: 8.8M
   CGroup: /system.slice/dhcpd.service
           └─30964 /usr/sbin/dhcpd -f -cf /etc/dhcp/dhcpd.conf -user dhcpd -group dhcpd --no-pid
………………省略部分输出信息………………
</code></pre>
<h4 id="19-2-2、配置TFTP服务程序"><a href="#19-2-2、配置TFTP服务程序" class="headerlink" title="19.2.2、配置TFTP服务程序"></a>19.2.2、配置<code>TFTP</code>服务程序</h4><blockquote>
<p>我们曾经学习过<code>vsftpd</code>服务与<code>TFTP</code>服务。<code>vsftpd</code>是一款功能丰富的文件传输服务程序，允许用户以匿</p>
<p>名开放模式、本地用户模式、虚拟用户模式来进行访问认证。但是，当前的客户端主机还没有安装操作</p>
<p>系统，该如何进行登录认证呢？<code>TFTP</code>作为一种基于<code>UDP</code>协议的简单文件传输协议，不需要进行用户认证</p>
<p>即可获取到所需的文件资源。因此接下来配置<code>TFTP</code>服务程序，<strong>为客户端主机提供引导及驱动文件</strong>。当客</p>
<p>户端主机有了基本的驱动程序之后，再通过<code>vsftpd</code>服务程序将完整的光盘镜像文件传输过去。</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# yum install -y tftp-server xinetd
</code></pre>
<blockquote>
<p><code>TFTP</code>是一种非常精简的文件传输服务程序，它的运行和关闭是由<code>xinetd</code>网络守护进程服务来管理的。</p>
<p><code>xinetd</code>服务程序会同时监听系统的多个端口，然后根据用户请求的端口号调取相应的服务程序来响应用</p>
<p>户的请求。需要开启TFTP服务程序时，只需在<code>xinetd</code>服务程序的配置文件中把<code>disable</code>参数改成<code>no</code>就</p>
<p>可以了。如果配置文件不存在，则复制下面的内容进来，手动创建一下</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# vim /etc/xinetd.d/tftp
service tftp
&#123;
        socket_type             = dgram
        protocol                = udp
        wait                    = yes
        user                    = root
        server                  = /usr/sbin/in.tftpd
        server_args             = -s /var/lib/tftpboot
        disable                 = no
        per_source              = 11
        cps                     = 100 2
        flags                   = IPv4
&#125;
</code></pre>
<blockquote>
<p>保存配置文件并退出，然后重启<code>xinetd</code>服务程序，并将其加入到开机启动项中。</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# systemctl restart xinetd
[root@linuxprobe ~]# systemctl enable  xinetd
</code></pre>
<h4 id="19-2-3、配置SYSLinux服务程序"><a href="#19-2-3、配置SYSLinux服务程序" class="headerlink" title="19.2.3、配置SYSLinux服务程序"></a>19.2.3、配置<code>SYSLinux</code>服务程序</h4><blockquote>
<p><code>SYSLinux</code>是一个用于<strong>提供引导加载的服务程序</strong>。与其说<code>SYSLinux</code>是一个服务程序，不如说是一个<strong>包含</strong></p>
<p><strong>了很多引导文件的文件夹</strong>。在安装好<code>SYSLinux</code>服务程序后，<code>/usr/share/syslinux</code>目录中会出现很</p>
<p>多引导文件。</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# yum install -y syslinux
</code></pre>
<blockquote>
<p>我们首先需要把<code>SYSLinux</code>提供的引导文件（也就是前文提到的文件<code>pxelinux.0</code>）复制到<code>TFTP</code>服务程</p>
<p>序的默认目录中，这样客户端主机就能够顺利地获取到引导文件了。另外在RHEL 8系统光盘镜像中也有</p>
<p>一些需要调取的引导文件。确认光盘镜像已经被挂载到<code>/media/cdrom</code>目录后，使用复制命令将光盘镜</p>
<p>像中自带的一些引导文件也复制到TFTP服务程序的默认目录中。</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# cd /var/lib/tftpboot
[root@linuxprobe tftpboot]# cp /usr/share/syslinux/pxelinux.0 .
[root@linuxprobe tftpboot]# cp /media/cdrom/images/pxeboot/* .
[root@linuxprobe tftpboot]# cp /media/cdrom/isolinux/* .
cp: overwrite &#39;./initrd.img&#39;? y
cp: overwrite &#39;./TRANS.TBL&#39;? y
cp: overwrite &#39;./vmlinuz&#39;? y
</code></pre>
<blockquote>
<p><code>cp</code>命令后面接的句点（.）表示当前工作目录。也就是说，上述<code>cp</code>表示将文件复制到当前工作目录</p>
<p>（即<code>/var/lib/tftpboot</code>）中。在复制过程中，若多个目录保存着相同的文件，则可手动敲击<code>y</code>键进行</p>
<p>覆盖即可。</p>
</blockquote>
<blockquote>
<p>然后在<code>TFTP</code>服务程序的目录中新建<code>pxelinux.cfg</code>目录。虽然该目录的名字带有后缀，但依然也是目</p>
<p>录，而非文件！将系统光盘中的开机选项菜单复制到该目录中，并命名为<code>defaul</code>t。这个<code>default</code>文</p>
<p>件就是开机时的选项菜单，如图19-4所示。</p>
</blockquote>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220825171657664.png" alt="图19-4 Linux系统的引导菜单界面"></p>
<pre><code class="bahs">[root@linuxprobe tftpboot]# mkdir pxelinux.cfg
[root@linuxprobe tftpboot]# cp /media/cdrom/isolinux/isolinux.cfg pxelinux.cfg/default
</code></pre>
<blockquote>
<p>默认的开机菜单中有3个选项：安装系统、对安装介质进行检验、排错模式。既然已经确定采用无人值守</p>
<p>的方式安装系统，若还需要为每台主机手动选择相应的选项，则未免与我们的主旨（无人值守安装）相</p>
<p>悖。</p>
</blockquote>
<blockquote>
<p>现在我们编辑这个<code>default</code>文件，把第1行的<code>default</code>参数修改为<code>linux</code>，这样系统在开机时就会默认</p>
<p>执行那个名称为<code>linux</code>的选项了。对应的<code>linux</code>选项大约在第64行，将默认的光盘镜像安装方式修改成</p>
<p><code>FTP</code>文件传输方式，并指定好光盘镜像的获取网址以及<code>Kickstart</code>应答文件的获取路径：</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe tftpboot]# vim pxelinux.cfg/default
  1 default linux
  2 timeout 600
  3 
  4 display boot.msg
  5 
  6 # Clear the screen when exiting the menu, instead of leaving the menu displayed.
  7 # For vesamenu, this means the graphical background is still displayed without
  8 # the menu itself for as long as the screen remains in graphics mode.
  9 menu clear
 10 menu background splash.png
 11 menu title Red Hat Enterprise Linux 8.0.0
 12 menu vshift 8
 13 menu rows 18
 14 menu margin 8
 15 #menu hidden
 16 menu helpmsgrow 15
 17 menu tabmsgrow 13
 18 
 19 # Border Area
 20 menu color border * #00000000 #00000000 none
 21 
 22 # Selected item
 23 menu color sel 0 #ffffffff #00000000 none
 24 
 25 # Title bar
 26 menu color title 0 #ff7ba3d0 #00000000 none
 27 
 28 # Press [Tab] message
 29 menu color tabmsg 0 #ff3a6496 #00000000 none
 30 
 31 # Unselected menu item
 32 menu color unsel 0 #84b8ffff #00000000 none
 33 
 34 # Selected hotkey
 35 menu color hotsel 0 #84b8ffff #00000000 none
 36 
 37 # Unselected hotkey
 38 menu color hotkey 0 #ffffffff #00000000 none
 39 
 40 # Help text
 41 menu color help 0 #ffffffff #00000000 none
 42 
 43 # A scrollbar of some type? Not sure.
 44 menu color scrollbar 0 #ffffffff #ff355594 none
 45 
 46 # Timeout msg
 47 menu color timeout 0 #ffffffff #00000000 none
 48 menu color timeout_msg 0 #ffffffff #00000000 none
 49 
 50 # Command prompt text
 51 menu color cmdmark 0 #84b8ffff #00000000 none
 52 menu color cmdline 0 #ffffffff #00000000 none
 53 
 54 # Do not display the actual menu unless the user presses a key. All that is displayed is a timeout message.
 55 
 56 menu tabmsg Press Tab for full configuration options on menu items.
 57 
 58 menu separator # insert an empty line
 59 menu separator # insert an empty line
 60 
 61 label linux
 62   menu label ^Install Red Hat Enterprise Linux 8.0.0
 63   kernel vmlinuz
 64   append initrd=initrd.img inst.stage2=ftp://192.168.10.10 ks=ftp://192.168.10.10/pub/ks.cfg quiet
 65 ………………省略部分输出信息………………
</code></pre>
<blockquote>
<p>建议在安装源的后面加入<code>quiet</code>参数，意为使用静默安装方式，不再需要用户进行确认。文件修改完毕</p>
<p>后保存即可。开机选项菜单是被调用的文件，因此不需要单独重启任何服务。</p>
</blockquote>
<h4 id="19-2-4、配置VSFtpd服务程序"><a href="#19-2-4、配置VSFtpd服务程序" class="headerlink" title="19.2.4、配置VSFtpd服务程序"></a>19.2.4、配置<code>VSFtpd</code>服务程序</h4><pre><code class="bash">[root@linuxprobe tftpboot]# yum install -y vsftpd
</code></pre>
<blockquote>
<p><code>RHEL 8</code>系统版本的<code>vsftpd</code>服务默认不允许匿名公开访问模式，因此需要手动进行开启</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~ ]# vim /etc/vsftpd/vsftpd.conf
# Example config file /etc/vsftpd/vsftpd.conf
#
# The default compiled in settings are fairly paranoid. This sample file
# loosens things up a bit, to make the ftp daemon more usable.
# Please see vsftpd.conf.5 for all compiled in defaults.
#
# READ THIS: This example file is NOT an exhaustive list of vsftpd options.
# Please read the vsftpd.conf.5 manual page to get a full idea of vsftpd&#39;s
# capabilities.
#
# Allow anonymous FTP? (Beware - allowed by default if you comment this out).
anonymous_enable=YES
………………省略部分输出信息………………
</code></pre>
<blockquote>
<p> 将相应的服务程序添加到开机启动项中</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# systemctl restart vsftpd
[root@linuxprobe ~]# systemctl enable  vsftpd
Created symlink /etc/systemd/system/multi-user.target.wants/vsftpd.service → /usr/lib/systemd/system/vsftpd.service.
</code></pre>
<blockquote>
<p>在确认系统光盘镜像已经正常挂载到<code>/media/cdrom</code>目录后，把目录中的光盘镜像文件全部复制到</p>
<p><code>vsftpd</code>服务程序的工作目录中</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# cp -r /media/cdrom/* /var/ftp
</code></pre>
<blockquote>
<p> 这个过程大约需要3～5分钟。在此期间，咱们也别闲着，将<code>SELinux</code>安全子系统中放行<code>FTP</code>传输协议的</p>
<p>允许策略，设置成<code>on</code>（开启）。</p>
</blockquote>
<pre><code class="bash">[root@linuxprobe ~]# setsebool -P ftpd_connect_all_unreserved=on
</code></pre>
<h4 id="19-2-5、创建KickStar应答文件"><a href="#19-2-5、创建KickStar应答文件" class="headerlink" title="19.2.5、创建KickStar应答文件"></a>19.2.5、创建<code>KickStar</code>应答文件</h4><p>毕竟，我们使用<code>PXE</code> +<code>Kickstart</code>部署的是一套“无人值守安装系统服务”，而不是“无人值守传输系统光盘</p>
<p>镜像服务”，因此还需要让客户端主机能够一边获取光盘镜像，一边自动帮用户填写好安装过程中出现的选</p>
<p>项。简单来说，如果生产环境中有100台服务器，它们需要安装相同的系统环境，那么在安装过程中单击的按</p>
<p>钮和填写的信息也应该都是相同的。那么，为什么不创建一个类似于备忘录的需求清单呢？这样，在无人值守</p>
<p>安装系统时，会从这个需求清单中找到相应的选项值，从而免去了手动输入之苦。更重要的是，这也彻底解放</p>
<p>了人的干预，彻底实现无人值守自动安装系统，而不是单纯地传输系统光盘镜像。</p>
<p>有了上文做铺垫，相信大家现在应该可以猜到<code>Kickstart</code>其实并不是一个服务程序，而是一个应答文件了。</p>
<p>是的！<code>Kickstart</code>应答文件中<strong>包含了系统安装过程中需要使用的选项和参数信息，系统可以自动调取这个应</strong></p>
<p><strong>答文件的内容，从而彻底实现无人值守安装系统。</strong>那么，既然这个文件如此重要，该去哪里找呢？其实在</p>
<p><code>root</code>管理员的家目录中有一个名为<code>anaconda-ks.cfg</code>的文件，它就是应答文件。下面将这个文件复制到</p>
<p><code>vsftpd</code>服务程序的工作目录中（在开机选项菜单的配置文件中已经定义了该文件的获取路径，也就是</p>
<p><code>vsftpd</code>服务程序数据目录中的<code>pub</code>子目录）。使用<code>chmod</code>命令设置该文件的权限，确保所有人都有可读的权</p>
<p>限，以保证客户端主机顺利获取到应答文件及里面的内容</p>
<pre><code class="bash">b[root@linuxprobe ~]# cp ~/anaconda-ks.cfg /var/ftp/pub/ks.cfg
[root@linuxprobe ~]# chmod +r /var/ftp/pub/ks.cfg
</code></pre>
<p><code>Kickstart</code>应答文件并没有想象中的那么复杂，它总共只有44行左右的参数和注释内容，大家完全可以通过</p>
<p>参数的名称及介绍来快速了解每个参数的作用。</p>
<p>其中，第1～10行表示安装硬盘的名称为<code>sda</code>及使用<code>LVM</code>技术。这便要求我们在后续新建客户端虚拟机时，硬</p>
<p>盘一定要选择<code>SCSI</code>或<code>SATA</code>类型的（见图19-5），否则会变成&#x2F;dev&#x2F;hd或&#x2F;dev&#x2F;nvme开头的名称，进而会因找</p>
<p>不到硬盘设备而终止安装进程。</p>
<p>第8行的软件仓库，应改为由FTP服务器提供的网络路径。第10行的安装源，也需要由CDROM改为网络安装</p>
<p>源</p>
<pre><code class="bash">  1 #version=RHEL8
  2 ignoredisk --only-use=sda
  3 autopart --type=lvm
  4 # Partition clearing information
  5 clearpart --none --initlabel
  6 # Use graphical install
  7 graphical
  8 repo --name=&quot;AppStream&quot; --baseurl=ftp://192.168.10.10/AppStream
  9 # Use CDROM installation media
 10 url --url=ftp://192.168.10.10/BaseOS
</code></pre>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829085748009.png" alt="图19-5 选择SCSI或SATA硬盘类型"></p>
<p>在第11～20行，<code>keyboard</code>参数为硬盘类型，一般都不需要修改。但一定要注意第17行的网卡信息，一定要</p>
<p>让网卡默认处于<code>DHCP</code>模式，否则在几十、上百台主机同时被创建出来后，会因为IP地址相互冲突而导致后续</p>
<p>无法管理。</p>
<pre><code class="bash"> 11 # Keyboard layouts
 12 keyboard --vckeymap=us --xlayouts=&#39;us&#39;
 13 # System language
 14 lang en_US.UTF-8
 15 
 16 # Network information
 17 network  --bootproto=dhcp --device=ens160 --onboot=on --ipv6=auto --activate
 18 network  --hostname=linuxprobe.com
 19 # Root password
 20 rootpw --iscrypted $6$EzIFyouUyBvWRIXv$y3bW3JZ2vD4c8bwVyKt7J90gyjULALTMLrnZZmvVujA75EpCCn50rlYm64MHAInbMAXAgn2Bmlgou/pYjUZzL1
</code></pre>
<p>在第21行～30行，<code>timezone</code>参数定义了系统默认时区为“上海”。如果大家的服务器时间不准确，则按照如下</p>
<p>修改即可。在第29行，创建了一个普通用户，密码值可复制<code>/etc/shadow</code>文件中的加密密文，它由系统自动</p>
<p>创建。</p>
<pre><code class="bash"> 21 # X Window System configuration information
 22 xconfig  --startxonboot
 23 # Run the Setup Agent on first boot
 24 firstboot --enable
 25 # System services
 26 services --disabled=&quot;chronyd&quot;
 27 # System timezone
 28 timezone Asia/Shanghai --isUtc --nontp
 29 user --name=linuxprobe --password=$6$a5fEjghDXGPvEoQc$HQqzvBlGVyhsJjgKFDTpiCEavS.inAwNTLZm/I5R5ALLKaMdtxZoKgb4/EaDyiPSSNNHGqrEkRnfJWap56m./. --iscrypted --gecos=&quot;linuxprobe&quot;
 30 
</code></pre>
<p>最后的第31～44行表示要安装的软件来源。<code>graphical-server-environment</code>即带有图形化界面的服务器环</p>
<p>境，它对应的是安装界面中的<code>Server With GUI</code>选项。</p>
<pre><code class="bash">b 31 %packages
 32 @^graphical-server-environment
 33 
 34 %end
 35 
 36 %addon com_redhat_kdump --disable --reserve-mb=&#39;auto&#39;
 37 
 38 %end
 39 
 40 %anaconda
 41 pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
 42 pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
 43 pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
 44 %end
</code></pre>
<p>由上可知，实际算下来的修改并不多，默认参数就已经非常合适了。最后预览一下<code>ks.cfg</code>文件的全貌。如果</p>
<p>大家在生产环境中需要用到这个文件，则可以直接复制并使用下面的内容</p>
<pre><code class="bash">[root@linuxprobe ~ ]# cat /var/ftp/pub/ks.cfg
#version=RHEL8
ignoredisk --only-use=sda
autopart --type=lvm
# Partition clearing information
clearpart --none --initlabel
# Use graphical install
graphical
repo --name=&quot;AppStream&quot; --baseurl=ftp://192.168.10.10/AppStream
# Use CDROM installation media
url --url=ftp://192.168.10.10/BaseOS
# Keyboard layouts
keyboard --vckeymap=us --xlayouts=&#39;us&#39;
# System language
lang en_US.UTF-8

# Network information
network  --bootproto=dhcp --device=ens160 --onboot=on --ipv6=auto --activate
network  --hostname=linuxprobe.com
# Root password
rootpw --iscrypted $6$EzIFyouUyBvWRIXv$y3bW3JZ2vD4c8bwVyKt7J90gyjULALTMLrnZZmvVujA75EpCCn50rlYm64MHAInbMAXAgn2Bmlgou/pYjUZzL1
# X Window System configuration information
xconfig  --startxonboot
# Run the Setup Agent on first boot
firstboot --enable
# System services
services --disabled=&quot;chronyd&quot;
# System timezone
timezone Asia/Shanghai --isUtc --nontp
user --name=linuxprobe --password=$6$a5fEjghDXGPvEoQc$HQqzvBlGVyhsJjgKFDTpiCEavS.inAwNTLZm/I5R5ALLKaMdtxZoKgb4/EaDyiPSSNNHGqrEkRnfJWap56m./. --iscrypted --gecos=&quot;linuxprobe&quot;

%packages
@^graphical-server-environment

%end

%addon com_redhat_kdump --disable --reserve-mb=&#39;auto&#39;

%end

%anaconda
pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
%end
</code></pre>
<h3 id="19-3、自动部署客户机"><a href="#19-3、自动部署客户机" class="headerlink" title="19.3、自动部署客户机"></a>19.3、自动部署客户机</h3><p>在按照上文讲解的方法成功部署各个相关的服务程序后，就可以使用<code>PXE </code>+ <code>Kickstart</code>无人值守安装系统</p>
<p>了。在采用下面的步骤建立虚拟主机时，一定要把客户端的网络模式设定成与服务端一致的“仅主机模式”，否</p>
<p>则两台设备无法进行通信，也就更别提自动安装系统了。其余硬件配置选项并没有强制性要求，大家可参考这</p>
<p>里的配置选项来设定。</p>
<blockquote>
<p><strong>第1步</strong>：打开“新建虚拟机向导”程序，选择“自定义（高级）”配置类型，然后单击“下一步”按钮，如图19-6</p>
<p>所示。在随后的虚拟机硬件兼容性选项中，选择默认的“Workstation 16.x”，步骤省略。</p>
</blockquote>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829090221306.png" alt="图19-6  选择虚拟机的配置类型"></p>
<blockquote>
<p><strong>第2步</strong>：将虚拟机操作系统的安装来源设置为“稍后安装操作系统”。这样做的目的是让虚拟机真正从网络</p>
<p>中获取系统安装镜像，同时也可避免<code>VMware Workstation</code>虚拟机软件按照内设的方法自行安装系统。</p>
<p>单击“下一步”按钮，如图19-7所示。</p>
</blockquote>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829090256335.png" alt="图19-7 设置虚拟机操作系统的安装来源"></p>
<blockquote>
<p><strong>第3步</strong>：将“客户机操作系统”设置为<code>Linux</code>，版本为“<code>Red Hat Enterprise Linux 8 64</code>位”，然后单</p>
<p>击“下一步”按钮，如图19-8所示。</p>
</blockquote>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829090324902.png" alt="图19-8 选择客户端主机的操作系统"></p>
<blockquote>
<p><strong>第4步</strong>：对虚拟机进行命名并设置安装位置。大家可自行定义虚拟机的名称，而安装位置则尽量选择磁盘</p>
<p>空间较大的分区。然后单击“下一步”按钮，如图19-9所示。在随后设置虚拟机处理器的个数及核心数、内</p>
<p>存容量值时，请大家根据实际情况自行选择，步骤省略。</p>
</blockquote>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829090412324.png" alt="图19-9 命名虚拟机并设置虚拟机的安装位置"></p>
<blockquote>
<p><strong>第5步</strong>：设置虚拟机主机的网络连接类型为“使用仅主机模式网络”，如图19-10所示。一定要确保服务器</p>
<p>与客户端同处于相同的网络模式，否则客户端无法获得从服务器传送过来的系统镜像及应答文件。随后</p>
<p>的<code>SCSI</code>控制器类型选择默认的<code>LSI Logic</code>，步骤省略。</p>
</blockquote>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829090446207.png" alt="图19-10 设置客户端的网络模式"></p>
<blockquote>
<p><strong>第6步</strong>：设置硬盘类型并指定容量。设置“虚拟磁盘类型”为SCSI或SATA，如图19-11所示。随后在硬盘创</p>
<p>建确认界面，选择“创建新虚拟磁盘”选项，步骤省略。</p>
</blockquote>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829090508460.png" alt="图19-11 设置虚拟硬盘类型为SCSI或SATA"></p>
<p>这里将“最大磁盘大小”设置为20GB。需要说明的是，这个20GB指的是虚拟机系统能够使用的最大上限，而不</p>
<p>是会被立即占满，因此设置得稍微大一些也没有关系。然后单击“下一步”按钮，如图19-12所示。随后的确认</p>
<p>硬盘文件名称界面选择默认值即可，步骤省略。</p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829090546999.png" alt="图19-12 将磁盘容量指定为20GB"></p>
<blockquote>
<p><strong>第7步</strong>：结束“新建虚拟机向导程序”后，先不要着急打开虚拟机系统。大家还需要单击图19-13中的“自定</p>
<p>义硬件”按钮，在弹出的如图19-14所示的界面中，把“网络适配器”设备同样也设置为“仅主机模式”（这个</p>
<p>步骤非常重要），移除其他不需要的硬件，然后单击“确定”按钮。</p>
</blockquote>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829090627650.png" alt="图19-13 单击虚拟机的“自定义硬件”按钮"></p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829090641736.png" alt="图19-14 设置虚拟机网络适配器设备为仅主机模式"></p>
<p>现在，我们就同时准备好了<code>PXE</code> +<code> Kickstart</code>无人值守安装系统与虚拟主机。在生产环境中，大家只需要将</p>
<p>配置妥当的服务器上架，接通服务器和客户端主机之间的网线，然后启动客户端主机即可。接下来就会按照图</p>
<p>19-15～图19-17那样，开始传输光盘镜像文件并进行自动安装了—期间完全无须人工干预，直到安装完毕时</p>
<p>才需要运维人员进行简单的初始化工作。</p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829090800477.png" alt="图19-15 自动传输光盘镜像文件并安装系统"></p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829090809659.png" alt="图19-16 根据应答文件自动填写安装信息"></p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829090820054.png" alt="图19-17 自动安装系统，无须人工干预"></p>
<p>由此可见，当生产环境工作中有数百台服务器需要批量安装系统时，使用无人值守安装系统的便捷性是不言而喻的。<strong>但是为了避免法律风险，红帽公司对于许可界面还不允许用应答文件自动完成</strong>，需要人工单击“<code>I accept the license agreement</code>”复选框后方可继续安装，如图19-18和图19-19所示，我们通过网络安装的客户端就搞定了。</p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829090902399.png" alt="图19-18 手动点击接受许可协议的按钮"></p>
<p><img src="/../image/linux%EF%BC%88%E4%B8%89%EF%BC%89/image-20220829090913327.png" alt="图19-19 顺利进入到新系统中"></p>

            </div>
            <hr/>
    
            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力!</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.bmp" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.bmp" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
    
            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>
    
            
            
            
            <div class="reprint1">
                <p>
                    <span class="reprint1-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="https://hcs-21.github.io" class="b-link-green">郝春帅的博客</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2022/08/24/linux%EF%BC%88%E4%B8%89%EF%BC%89/" class="b-link-green">linux的使用教程（三）</a>
                </p>
            </div>
    
        </div>
    </div>
    
    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'Iv1.fc0d9004c04bd10f',
        clientSecret: 'ae1026f1a6a57e97dbd91e20bb433d5f87c2f220',
        repo: 'hcs-21.github.io',
        owner: 'hcs-21',
        admin: ["hcs-21"],
        id: '2022/08/24/linux（三）/',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    
    
    
    
    
    
    
    
    
    
    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/08/29/homeWork0827/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="私教第一周">
                        
                        <span class="card-title">私教第一周</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            私教第一周
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2022-08-29
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/homeWork%E6%95%99%E7%A8%8B/" class="post-category" target="_blank">
                                    homeWork教程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" target="_blank">
                        <span class="chip bg-color">大数据</span>
                    </a>
                    
                    <a href="/tags/study/" target="_blank">
                        <span class="chip bg-color">study</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/08/22/linux%EF%BC%88%E4%BA%8C%EF%BC%89/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="linux的使用教程（二）">
                        
                        <span class="card-title">linux的使用教程（二）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            linux的使用教程
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2022-08-22
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%B3%BB%E7%BB%9F/" class="post-category" target="_blank">
                                    系统
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/linux/" target="_blank">
                        <span class="chip bg-color">linux</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }
    
        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());
    
        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }
    
        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 郝春帅的博客<br />'
            + '作者: 郝帅<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';
    
        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


        <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            Copyright&copy;  郝帅. 


            <br>
            <span id="sitetime"></span><span class="my-face">ღゝ◡╹)ノ♡</span>
            <br>
    
            
    
            
                    
                        <span id="busuanzi_container_site_pv" style='display:none'></span>
                        总访问量: <span id="busuanzi_value_site_pv" class="white-color"></span>
                    
        
                    
                        <span id="busuanzi_container_site_uv" style='display:none'></span>
                        人次&nbsp; | &nbsp;访客人数: <span id="busuanzi_value_site_uv" class="white-color"></span> 人
                    
    
            
			


            
            <br>
    
        </div>
    
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/hcs-21.github.io" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>


 
    <a href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=haocs21@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>






    <a href="http://wpa.qq.com/msgrd?v=3&uin=993999150&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的QQ空间" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>





    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    
    </div>
</footer>

<div class="progress-bar"></div>
<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();

        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
    
        var t1 = Date.UTC(2022, 06, 24, 00, 00, 00); //北京时间2019-8-1 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes *
            minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已勉强运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours +
            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒" ;
    } /*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>






        <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
        <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


        <script src="https://cdn.bootcss.com/materialize/1.0.0/js/materialize.min.js"></script>
        <script src="https://cdn.bootcss.com/masonry/4.2.2/masonry.pkgd.min.js"></script>
        <script src="https://cdn.bootcss.com/aos/3.0.0-beta.6/aos.js"></script>
        <script src="https://cdn.bootcss.com/scrollprogress/3.0.2/scrollProgress.min.js"></script>
        <script src="https://cdn.bootcss.com/lightgallery/1.6.12/js/lightgallery-all.min.js"></script>
        <script src="/js/matery.js"></script>

        <!-- Global site tag (gtag.js) - Google Analytics -->



        
            <script src="/libs/others/clicklove.js"></script>
        

        
            <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        

        <!-- 洪卫 shw2018 add 2019.08.28 -->
        <script type="text/javascript">
            var OriginTitile = document.title,
                st;
            document.addEventListener("visibilitychange", function () {
                document.hidden ? (document.title = "看不见我🙈~看不见我🙈~", clearTimeout(st)) : (document.title =
                    "(๑•̀ㅂ•́) ✧被发现了～", st = setTimeout(function () {
                        document.title = OriginTitile
                    }, 3e3))
            })
        </script>

        <!-- 鼠标点击烟花爆炸效果  洪卫 shw2018 add 2019.09.09 -->
        

        <!-- 背景雪花飘落特效洪卫 shw2018 add 2019.09.10 -->
        
            <script type="text/javascript">
            //只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/js/sakura.js"><\/script>');
            }
            </script>
        

        <!-- 鼠标点击文字特效 洪卫 shw2018 add 2019.09.10-->
        
            <script src="/js/wenzi.js" type="text/javascript"></script>
        

        <!-- 背景雪花飘落特效 洪卫 shw2018 add 2019.09.10 -->
        
            <script type="text/javascript">
                var windowWidth = $(window).width();
                if (windowWidth > 768) {
                    document.write('<script type="text/javascript" src="/js/xuehuapiaoluo.js"><\/script>');
                }
            </script>
        

        <!-- 在线聊天工具  洪卫 shw2018 add 2019.09.11 -->
        
            <script src="//code.tidio.co/xxxxxxxxxxxxxxxxxxxxxxxxxxx.js"></script>
            <!--  在线聊天位置自定义  洪卫 shw2018 add 2019.09.13  -->
            <script> 
                $(document).ready(function () {

                    setInterval(change_Tidio, 50);  
                    function change_Tidio() { 

                        var tidio=$("#tidio-chat iframe");
                        if(tidio.css("display")=="block"&& $(window).width()>977 ){
                            document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"80px":"20px";   
                            document.getElementById("tidio-chat-iframe").style.right="-15px";   
                            document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                            document.getElementById("tidio-chat-iframe").style.zIndex="997";
                        } 
                        else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                            document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;   
                            document.getElementById("tidio-chat-iframe").style.right="-15px"; 
                            document.getElementById("tidio-chat-iframe").style.zIndex="997";
                        }
                        else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                            document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;   
                            document.getElementById("tidio-chat-iframe").style.zIndex="997";
                        }

                        if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                            document.getElementById("tidio-chat-iframe").style.zIndex="998";
                        }
                    } 
                }); 
            </script>
        

        <!-- 背景 canvas-nest  洪卫 shw 2018  add 2019.09.15-->
        
            <script type="text/javascript">
            var windowWidth = $(window).width();
            if (windowWidth > 992) {
                document.write('<script type="text/javascript" color="0,0,255" pointColor="0,0,255" opacity= "0.8" zIndex="--1" count="150"src="/libs/background/canvas-nest.js"><\/script>');
            }
            </script>
        

        <!-- 背景静止彩带  洪卫 shw 2018  add 2019.09.15-->
        

        <!-- 背景动态彩带 洪卫 shw 2018  add 2019.09.15-->
        
            <script type="text/javascript">
            var windowWidth = $(window).width();
            if (windowWidth > 992) {
                document.write('<script type="text/javascript" src="/libs/background/ribbon-dynamic.js"><\/script>');
            }
            </script>
        

    </body>
</html>